
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Bristol GIN for Silicon Probe Data</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css-rules.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bristol GIN for Patch Clamp Data" href="Bristol%20GIN%20for%20Patch%20Clamp%20Data.html" />
    <link rel="prev" title="Bristol GIN via Command Line" href="Bristol%20GIN%20via%20Command%20Line.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Bristol Neuroscience Data Guide
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Installation%20Instructions%20for%20GIN%20Client.html">
   Installation Instructions for GIN Client
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Installation%20Instructions%20for%20GIN%20Server.html">
   Installation Instructions for GIN Server
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Repository%20Management%20with%20GIN.html">
   Repository Management with GIN
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Repository%20Management%20with%20GIN%20Web%20Interface.html">
   Repository Management with GIN Web Interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Repository%20Management%20with%20WinGIN.html">
   Repository Management with WinGIN
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Repository%20Management%20with%20GIN%20Client.html">
   Repository Management with GIN Client
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Repository%20Management%20with%20Git.html">
   Repository Management with Git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/Recording%20Metadata.html">
   Recording Metadata
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Bristol%20GIN%20via%20Graphical%20Interfaces.html">
   Bristol GIN via Graphical Interfaces
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Bristol%20GIN%20via%20Command%20Line.html">
   Bristol GIN via Command Line
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Bristol GIN for Silicon Probe Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Bristol%20GIN%20for%20Patch%20Clamp%20Data.html">
   Bristol GIN for Patch Clamp Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Bristol%20GIN%20for%20Calcium%20Imaging%20Data.html">
   Bristol GIN for Calcium Imaging Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Bristol%20GIN%20for%20Neuroimaging%20Data.html">
   Bristol GIN for Neuroimaging Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Converting%20to%20NWB.html">
   Converting to NWB
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Converting%20to%20BIDS.html">
   Converting to BIDS
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/Community.html">
   Community
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/Bristol%20GIN%20Project.html">
   Bristol GIN Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/GIN%20Project.html">
   GIN Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/GIN-Tonic%20Project.html">
   GIN-Tonic Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/NWB%20Project.html">
   NWB Project
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources/BIDS%20Project.html">
   BIDS Project
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/dervinism/bristol-neuroscience-data-guide"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/dervinism/bristol-neuroscience-data-guide/issues/new?title=Issue%20on%20page%20%2Ftutorials/Bristol GIN for Silicon Probe Data.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/tutorials/Bristol GIN for Silicon Probe Data.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-gin-account">
   Create GIN Account
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-repository-to-store-your-research-data">
   Create Repository to Store Your Research Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-your-research-data-repository">
   Set up Your Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#record-your-local-research-data-repository-changes">
   Record Your Local Research Data Repository Changes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#update-your-remote-research-data-repository">
   Update Your Remote Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-content-of-your-local-research-data-repository">
   Remove Content of Your Local Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compress-raw-data">
   Compress Raw Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-your-data-to-standardised-format">
   Convert Your Data to Standardised Format
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-to-nwb-using-matlab">
     Convert to NWB Using Matlab
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#install-matnwb-toolbox">
       Install MatNWB Toolbox
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#record-metadata">
       Record Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#construct-electrodes-table">
       Construct Electrodes Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#load-and-initialise-spiking-data">
       Load and Initialise Spiking Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#load-waveforms">
       Load Waveforms
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#construct-units-table">
       Construct Units Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#add-behavioural-module-pupil-area-size">
       Add Behavioural Module: Pupil Area Size
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#add-behavioural-module-total-facial-movement">
       Add Behavioural Module: Total Facial Movement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#save-nwb-file">
       Save NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#read-nwb-file">
       Read NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#validate-nwb-file">
       Validate NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#resources">
       Resources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-to-nwb-using-python">
     Convert to NWB Using Python
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#install-pynwb">
       Install PyNWB
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-record-metadata">
       Record Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-electrodes-table">
       Construct Electrodes Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-init-spiking-data">
       Load and Initialise Spiking Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-load-waveforms">
       Load Waveforms
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-units-table">
       Construct Units Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-pupil-area">
       Add Behavioural Module: Pupil Area Size
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-movement">
       Add Behavioural Module: Total Facial Movement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-save">
       Save NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-read">
       Read NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-validate">
       Validate NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-resources">
       Resources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-nwb-file-structure-using-hdfview">
     Examine NWB File Structure Using HDFView
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#upload-your-standardised-data-to-remote-repository">
   Upload Your Standardised Data to Remote Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#roll-back-repository-to-an-earlier-version">
   Roll back Repository to an Earlier Version
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Bristol GIN for Silicon Probe Data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-gin-account">
   Create GIN Account
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-repository-to-store-your-research-data">
   Create Repository to Store Your Research Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-your-research-data-repository">
   Set up Your Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#record-your-local-research-data-repository-changes">
   Record Your Local Research Data Repository Changes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#update-your-remote-research-data-repository">
   Update Your Remote Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-content-of-your-local-research-data-repository">
   Remove Content of Your Local Research Data Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compress-raw-data">
   Compress Raw Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-your-data-to-standardised-format">
   Convert Your Data to Standardised Format
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-to-nwb-using-matlab">
     Convert to NWB Using Matlab
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#install-matnwb-toolbox">
       Install MatNWB Toolbox
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#record-metadata">
       Record Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#construct-electrodes-table">
       Construct Electrodes Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#load-and-initialise-spiking-data">
       Load and Initialise Spiking Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#load-waveforms">
       Load Waveforms
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#construct-units-table">
       Construct Units Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#add-behavioural-module-pupil-area-size">
       Add Behavioural Module: Pupil Area Size
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#add-behavioural-module-total-facial-movement">
       Add Behavioural Module: Total Facial Movement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#save-nwb-file">
       Save NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#read-nwb-file">
       Read NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#validate-nwb-file">
       Validate NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#resources">
       Resources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-to-nwb-using-python">
     Convert to NWB Using Python
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#install-pynwb">
       Install PyNWB
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-record-metadata">
       Record Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-electrodes-table">
       Construct Electrodes Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-init-spiking-data">
       Load and Initialise Spiking Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-load-waveforms">
       Load Waveforms
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-units-table">
       Construct Units Table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-pupil-area">
       Add Behavioural Module: Pupil Area Size
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-movement">
       Add Behavioural Module: Total Facial Movement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-save">
       Save NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-read">
       Read NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-validate">
       Validate NWB File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tutorials-silicon-probe-convert2nwb-py-resources">
       Resources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-nwb-file-structure-using-hdfview">
     Examine NWB File Structure Using HDFView
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#upload-your-standardised-data-to-remote-repository">
   Upload Your Standardised Data to Remote Repository
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#roll-back-repository-to-an-earlier-version">
   Roll back Repository to an Earlier Version
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="bristol-gin-for-silicon-probe-data">
<span id="tutorials-silicon-probe"></span><h1>Bristol GIN for Silicon Probe Data<a class="headerlink" href="#bristol-gin-for-silicon-probe-data" title="Permalink to this headline">#</a></h1>
<section id="create-gin-account">
<span id="tutorials-silicon-probe-create-account"></span><h2>Create GIN Account<a class="headerlink" href="#create-gin-account" title="Permalink to this headline">#</a></h2>
<p>In order to be able to follow this tutorial, you need to have a GIN account either on Bristol GIN or on the public GIN service. GIN web interface documentation has it all explained <a class="reference internal" href="../documentation/Repository%20Management%20with%20GIN%20Web%20Interface.html#doc-gin-web-register"><span class="std std-ref">here</span></a>.</p>
<p>After creating the account, login to it by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">login</span>
</pre></div>
</div>
</section>
<section id="create-repository-to-store-your-research-data">
<span id="tutorials-silicon-probe-create-repo"></span><h2>Create Repository to Store Your Research Data<a class="headerlink" href="#create-repository-to-store-your-research-data" title="Permalink to this headline">#</a></h2>
<p>The example repository is organised according to the <a class="reference external" href="https://github.com/tonic-team/Tonic-Research-Project-Template">Tonic Research Project Template</a>. You can organise your data according to this template by following a few simple steps. First, go to your GIN web page (GIN-domain-name/your-username) and click on the Import Repository button.</p>
<a class="reference internal image-reference" href="../_images/import-repo.png" id="fig-gin-silicon-import-repo"><img alt="../_images/import-repo.png" class="align-center" id="fig-gin-silicon-import-repo" src="../_images/import-repo.png" style="width: 690px;" /></a>
<p>       <strong>Figure 1. Import Repository</strong></p>
<p>You should be brought to the Import Repository page. As a Clone Address specify the Tonic template github page: <a class="reference external" href="https://github.com/tonic-team/Tonic-Research-Project-Template">https://github.com/tonic-team/Tonic-Research-Project-Template</a>. Give the name to your repository and a concise description of the kind of data stored in the repository. In my case I am creating a repository containing dual silicon probe recordings of spontaneous neural activity in various brain areas of the mouse. Then click the green Migrate Repository button.</p>
<a class="reference internal image-reference" href="../_images/import-repo2.png" id="fig-gin-silicon-import-repo2"><img alt="../_images/import-repo2.png" class="align-center" id="fig-gin-silicon-import-repo2" src="../_images/import-repo2.png" style="width: 690px;" /></a>
<p>       <strong>Figure 2. Describe Your New Repository</strong></p>
<p>You should see the template contents cloned under your new repository name.</p>
<p>Now open the terminal and navigate to the folder on your local file system where you would like to keep your research data. Download the remote repository to that location by typing this command (replace the repository path with your own):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span> <span class="n">dervinism</span><span class="o">/</span><span class="n">infraslow</span><span class="o">-</span><span class="n">dynamics</span>
</pre></div>
</div>
<p>You can now use this empty repository to store all of your newly acquired research project data and documents. If you already have data that was generated in the past, you can copy it here.</p>
</section>
<section id="set-up-your-research-data-repository">
<span id="tutorials-silicon-probe-setup-repo"></span><h2>Set up Your Research Data Repository<a class="headerlink" href="#set-up-your-research-data-repository" title="Permalink to this headline">#</a></h2>
<p>I am going to copy old research data to this newly created repository and make certain rearrangements within the existing folder structure to make it more suitable for already existing data structures created while carrying out my research project. I am also going to use mock research data to reduce the size of the repository so that repository management actions can be performed fast for this tutorial. The <a class="reference external" href="https://gin.g-node.org/dervinism/mock-ecephys-project">mock data repository</a> is available to download on GIN. You can download it by typing the line below in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span> <span class="n">dervinism</span><span class="o">/</span><span class="n">mock</span><span class="o">-</span><span class="n">ecephys</span><span class="o">-</span><span class="n">project</span>
<span class="n">cd</span> <span class="n">mock</span><span class="o">-</span><span class="n">ecephys</span><span class="o">-</span><span class="n">project</span>
<span class="n">gin</span> <span class="n">get</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
<p>Once downloaded, open the repository and copy the contents of the repository except for the .git folder. Delete the contents of the infraslow-dynamics repository and paste the copied contents from the mock-ecephys-project repository. Edit the README file accordingly to reflect the new name of the repository and other info.</p>
</section>
<section id="record-your-local-research-data-repository-changes">
<span id="tutorials-silicon-probe-commit"></span><h2>Record Your Local Research Data Repository Changes<a class="headerlink" href="#record-your-local-research-data-repository-changes" title="Permalink to this headline">#</a></h2>
<p>Once your repository is set up (data folders organised, data files placed in right locations, etc.), you should register the state of your repository with the local version control system. By doing so you create the image of your repository that can always be reverted to in the future in case the need to do so arises. When commiting local repository changes to your version control system you typically provide a concise message describing the changes. By convention, the message length should not exceed 50 characters. As for the first record, we type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">commit</span> <span class="o">.</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>
<p>This action would commit all changes locally. Dot means that the command is executed on the contents of the current working directory; therefore, make sure that you are inside the root folder of your repository when carrying out this action. The flag -m is used to pass the commit message. When you make new changes to the repository, whether editing text files or manipulating your data files, you should commit these changes periodically to your local versioning system by executing in the terminal a similar command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">commit</span> <span class="o">.</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;A message describing new changes&quot;</span>
</pre></div>
</div>
</section>
<section id="update-your-remote-research-data-repository">
<span id="tutorials-silicon-probe-upload"></span><h2>Update Your Remote Research Data Repository<a class="headerlink" href="#update-your-remote-research-data-repository" title="Permalink to this headline">#</a></h2>
<p>All of the changes that were commited previously, were done so locally. We were working on a local copy of our research data repository. In order to update our remote research data respository, whether residing on Bristol GIN or on the public GIN server, we need to push our local changes to the remote copy of our repository. We do so by simply executing the line below in the terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">upload</span> <span class="o">.</span>
</pre></div>
</div>
<p>Any new files and any new changes to exisiting files should now be uploaded onto the remote repository and we should be able to see them if we navigated to the repository web page. Alternatively, we can also update the remote repository using the web interface. We do so by navigating to the repository webpage and clicking the blue Upload file button.</p>
<a class="reference internal image-reference" href="../_images/upload-repo.png" id="fig-gin-silicon-upload-repo"><img alt="../_images/upload-repo.png" class="align-center" id="fig-gin-silicon-upload-repo" src="../_images/upload-repo.png" style="width: 690px;" /></a>
<p>       <strong>Figure 3. Update Remote Repository via Web</strong></p>
<p>The limitation of using the web interface is that every time you update your remote repository, you will be limited to uploading 100 files at a time with each file being no larger than 10 gigabytes. Therefore, it is more effecient/effective to use the command line tools which have none of these limitations.</p>
<p>When you use the web interface, you can specify the commit message title (no more than 50 characters by convention) and the commit message body (no more than 72 characters by convention).</p>
</section>
<section id="remove-content-of-your-local-research-data-repository">
<span id="tutorials-silicon-probe-remove-content"></span><h2>Remove Content of Your Local Research Data Repository<a class="headerlink" href="#remove-content-of-your-local-research-data-repository" title="Permalink to this headline">#</a></h2>
<p>One advantage of using GIN for your data repository mangement is that you do not need to keep duplicate repositories in order to prevent accidental detrimental changes to your main repository. One reason for that is having version control system. The other reason is that you can safely remove the content of your local repository and replace it with pointers to original files. As a result you can save space on your local hard-drive. To remove the local content type the following line in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">remove</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
<p>Local files larger than 10 megabytes should be replaced by symbolic links. In case you want to remove the content of specific files only, you can type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">remove</span><span class="o">-</span><span class="n">content</span> <span class="o">&lt;</span><span class="n">absolute</span> <span class="ow">or</span> <span class="n">relative</span> <span class="n">path</span> <span class="n">to</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">folder</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example, to remove the raw research data from our silicon probe recording repository, we type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">remove</span><span class="o">-</span><span class="n">content</span> <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span>
<span class="n">gin</span> <span class="n">remove</span><span class="o">-</span><span class="n">content</span> <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span>
</pre></div>
</div>
<p>To simply restore the file content type in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
<p>If you no longer need to work on your repository and its remote copy is up to date with the local copy, you can simply delete the local repository copy altogether. You should always be able to restore your repository and all of its contents on your local machine by executing these commands in your terminal (replace the repository path as appropriate):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span> <span class="n">dervinism</span><span class="o">/</span><span class="n">mock</span><span class="o">-</span><span class="n">ecephys</span><span class="o">-</span><span class="n">project</span>
<span class="n">cd</span> <span class="n">mock</span><span class="o">-</span><span class="n">ecephys</span><span class="o">-</span><span class="n">project</span>
<span class="n">gin</span> <span class="n">get</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
</section>
<section id="compress-raw-data">
<span id="tutorials-silicon-probe-compress"></span><h2>Compress Raw Data<a class="headerlink" href="#compress-raw-data" title="Permalink to this headline">#</a></h2>
<p>Silicon probe recording raw data files take a lot of space, especially neuropixels recordings. Often these files consume most of the hard-disk space compared to any other files produced during the data processing. It is, therefore, advisable to compress them. The International Brain Laboratory has provided compression software for that purpose which is easy to use with instructions on how to install and compress your files provided <a class="reference external" href="https://github.com/int-brain-lab/mtscomp">here</a>. Briefly, you can install it by typing in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">mtscomp</span>
</pre></div>
</div>
<p>Make sure you also have the required dependencies installed.</p>
<p>Once installed, the compression is straight forward. All you need is to specify the name of your binary file, number of recording channels, the sampling rate, and the binary data type as in the example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mtscomp</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">filename</span><span class="o">&gt;.</span><span class="n">bin</span> <span class="o">-</span><span class="n">n</span> <span class="mi">385</span> <span class="o">-</span><span class="n">s</span> <span class="mi">30000</span> <span class="o">-</span><span class="n">d</span> <span class="n">int16</span>
</pre></div>
</div>
<p>The compression software will produce <code class="docutils literal notranslate"><span class="pre">&lt;data-filename&gt;.cbin</span></code> compressed file and <code class="docutils literal notranslate"><span class="pre">&lt;data-filename&gt;.ch</span></code> json metadata file describing the compression parameters. These two files should be preserved while the original data binary file can be deleted. To restore the original file, type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mtsdecomp</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">filename</span><span class="o">&gt;.</span><span class="n">cbin</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">filename</span><span class="o">&gt;.</span><span class="n">bin</span>
</pre></div>
</div>
<p>You can expect a three-fold reduction in the file size after the compression. So it is a good way to greatly reduce the size of your repositories.</p>
</section>
<section id="convert-your-data-to-standardised-format">
<span id="tutorials-silicon-probe-convert2nwb"></span><h2>Convert Your Data to Standardised Format<a class="headerlink" href="#convert-your-data-to-standardised-format" title="Permalink to this headline">#</a></h2>
<p>In order to increase your research data’s adherence to the <a class="reference external" href="https://www.go-fair.org/fair-principles/">FAIR principles</a> of scientific data management and, in particular, to increase the interoperability of your data and chances of it being reused beyond its original purpose of collection, it is highly advisable to convert your data into one of the more popular standard file formats for neuroscience data. One such format is the <a class="reference external" href="https://www.nwb.org/">Neurodata Without Borders (NWB)</a> which is highly suitable for most of the neurophysiology data. Programming interfaces in both Matlab and Python are available for converting your data. Here we are going to provide explanations of how you can convert your data in both programming languages. While showing you examples of that, we will continue our focus on the extracellular electrophysiology data.</p>
<section id="convert-to-nwb-using-matlab">
<span id="tutorials-silicon-probe-convert2nwb-matlab"></span><h3>Convert to NWB Using Matlab<a class="headerlink" href="#convert-to-nwb-using-matlab" title="Permalink to this headline">#</a></h3>
<section id="install-matnwb-toolbox">
<span id="tutorials-silicon-probe-convert2nwb-matlab-install-matnwb"></span><h4>Install MatNWB Toolbox<a class="headerlink" href="#install-matnwb-toolbox" title="Permalink to this headline">#</a></h4>
<p>To begin with the Matlab demonstration, you would need to install <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/">MatNWB toolbox</a>. To download the toolbox, type in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NeurodataWithoutBorders</span><span class="o">/</span><span class="n">matnwb</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Move the downloaded repository to the folder where you keep your code libraries. Then type the following in the Matlab command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">matnwb</span>
<span class="n">addpath</span><span class="p">(</span><span class="n">genpath</span><span class="p">(</span><span class="n">pwd</span><span class="p">));</span>
<span class="n">generateCore</span><span class="p">();</span>
</pre></div>
</div>
<p>You can now start using MatNWB. MatNWB interface documentation can be accessed <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/index.html">here</a>.</p>
</section>
<section id="record-metadata">
<span id="tutorials-silicon-probe-convert2nwb-matlab-record-metadata"></span><h4>Record Metadata<a class="headerlink" href="#record-metadata" title="Permalink to this headline">#</a></h4>
<p>We have prepared example repositories containing single session extracellular physiology recording data collected with <a class="reference external" href="https://gin.g-node.org/dervinism/convert2nwbMatNnx">Neuronexus</a> and <a class="reference external" href="https://gin.g-node.org/dervinism/convert2nwbMatNpx">Neuropixels</a> probes and Matlab scripts that would convert that data to the NWB format. They can be used to familiarise with the Matlab NWB conversion scheme for spiking data combined with behavioural measurements. Both conversion scripts are very similar and, thus, we will focus on the Neuropixels use case.</p>
<p>To donwload the Neuropixels repository, type in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span> <span class="n">dervinism</span><span class="o">/</span><span class="n">convert2nwbMatNpx</span>
<span class="n">cd</span> <span class="n">convert2nwbMatNpx</span>
<span class="n">gin</span> <span class="n">get</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
<p>It will take some time to download the full repository. Once the download is complete you can open the <code class="docutils literal notranslate"><span class="pre">convert2nwb.m</span></code> file and and execute it right away. The script would load derived spiking and behavioural data from <code class="docutils literal notranslate"><span class="pre">convert2nwbMatNpx/npx_derived_data/M200324_MD/M200324_MD.mat</span></code> file, convert it to the NWB format, and save it inside <code class="docutils literal notranslate"><span class="pre">convert2nwbMatNpx/npx_derived_data_nwb</span></code> folder as <code class="docutils literal notranslate"><span class="pre">ecephys_session_01.nwb</span></code> file.</p>
<p>We will now analyse the conversion script in more detail. The script starts by executing three parameter files to initiate the conversion environment. The first parameter file <code class="docutils literal notranslate"><span class="pre">nwbParams.m</span></code> contains the most general type of parameters that apply to all animals and recording sessions of the experiment, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">projectName</span> <span class="o">=</span> <span class="s1">&#39;Brainwide Infraslow Activity Dynamics&#39;</span><span class="p">;</span>
<span class="n">experimenter</span> <span class="o">=</span> <span class="s1">&#39;Martynas Dervinis&#39;</span><span class="p">;</span>
<span class="n">institution</span> <span class="o">=</span> <span class="s1">&#39;University of Leicester&#39;</span><span class="p">;</span>
<span class="n">publications</span> <span class="o">=</span> <span class="s1">&#39;In preparation&#39;</span><span class="p">;</span>
<span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Michael Okun lab&#39;</span><span class="p">;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;neuropixels&#39;</span><span class="p">;</span>
<span class="n">videoFrameRate</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span> <span class="o">%</span> <span class="n">Hz</span>
</pre></div>
</div>
<p>The names of most of these parameters are self-explanatory. The videoFrameRate variable contains the camera’s frame rate recording the animal’s pupil. There are also input and output folders defined at the bottom of the parameter file. They include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rawDataFolder</span></code> which contains probe recording channel maps and unit waveform files;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">derivedDataFolder</span></code> which contains processed spiking data;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">derivedDataFolderNWB</span></code> which is the output folder where converted NWB files are saved.</p></li>
</ul>
<p>As the name implies, <code class="docutils literal notranslate"><span class="pre">nwbAnimalParams.m</span></code> file contains parameters specific to a particular animal and common to all recording sessions for that animal. They include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">animalID</span> <span class="o">=</span> <span class="s1">&#39;M200324_MD&#39;</span><span class="p">;</span>
<span class="n">dob</span> <span class="o">=</span> <span class="s1">&#39;20200206&#39;</span><span class="p">;</span> <span class="o">%</span> <span class="n">yyyymmdd</span>
<span class="o">...</span>
<span class="n">strain</span> <span class="o">=</span> <span class="s1">&#39;C57BL/6J&#39;</span><span class="p">;</span>
<span class="n">sex</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">;</span>
<span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;Mus musculus&#39;</span><span class="p">;</span>
<span class="n">weight</span> <span class="o">=</span> <span class="p">[];</span>
<span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;025&#39;</span><span class="p">;</span> <span class="o">%</span> <span class="n">Animal</span> <span class="n">testing</span> <span class="n">order</span><span class="o">.</span>
</pre></div>
</div>
<p>Names of these parameters are self-explanatory. The script also defines input and output folders specifically for the animal of interest.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nwbSessionParams.m</span></code> file stores parameters about recording sessions. Some of these parameters are defined at the top of the file explicitly for each individual session and some even explicitly for each recording probe, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sessionID</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;20200324161349&#39;</span><span class="p">};</span>
<span class="n">sessionDescription</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anaesthesia&#39;</span><span class="p">};</span>
<span class="n">sessionNotes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;...&#39;</span><span class="p">};</span>
<span class="n">endCh</span><span class="p">{</span><span class="mi">1</span><span class="p">}{</span><span class="mi">1</span><span class="p">}</span> <span class="o">=</span> <span class="p">[</span><span class="mi">88</span> <span class="mi">117</span> <span class="mi">149</span> <span class="mi">342</span> <span class="mi">384</span><span class="p">];</span> <span class="o">%</span> <span class="n">Corresponding</span> <span class="n">probe</span> <span class="n">end</span> <span class="n">channels</span> <span class="n">starting</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">tip</span> <span class="n">of</span> <span class="n">the</span> <span class="n">probe</span><span class="o">.</span> <span class="n">Corresponding</span> <span class="ow">and</span> <span class="n">previous</span> <span class="n">end</span> <span class="n">channels</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span> <span class="n">work</span> <span class="n">out</span> <span class="n">probe</span> <span class="n">channels</span> <span class="n">that</span> <span class="n">reside</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">brain</span> <span class="n">area</span><span class="o">.</span>
<span class="n">endCh</span><span class="p">{</span><span class="mi">1</span><span class="p">}{</span><span class="mi">2</span><span class="p">}</span> <span class="o">=</span> <span class="p">[</span><span class="mi">41</span> <span class="mi">091</span> <span class="mi">138</span> <span class="mi">217</span> <span class="mi">304</span> <span class="mi">384</span><span class="p">];</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">for</span></code> loop that follows next sets the remaining parameters that are common across recording sessions, like <code class="docutils literal notranslate"><span class="pre">electrodeName</span></code>, <code class="docutils literal notranslate"><span class="pre">electrodeDescription</span></code>, <code class="docutils literal notranslate"><span class="pre">electrodeManufacturer</span></code>, <code class="docutils literal notranslate"><span class="pre">nShanks</span></code> (number of probe shanks), <code class="docutils literal notranslate"><span class="pre">nChannelsPerShank</span></code> (number of recording channels per shank), <code class="docutils literal notranslate"><span class="pre">nCh</span></code> (total number of probe channels), <code class="docutils literal notranslate"><span class="pre">areas</span></code> (brain areas that probes span), <code class="docutils literal notranslate"><span class="pre">electrodeCoordinates</span></code> (electrode insertion coordinates), <code class="docutils literal notranslate"><span class="pre">electrodeLabel</span></code>, and <code class="docutils literal notranslate"><span class="pre">electrodeImplantationType</span></code> (i.e., acute or chronic).</p>
<p>Most of the parameters defined in the three parameter files comprise metadata. The way you define your metadata may be different. For example, you may have your own custom scripts that contain the metadata or you may store your metadata in files organised according to one of standard neuroscientific metadata formats like <a class="reference external" href="http://g-node.github.io/python-odml/">odML</a>. Whichever your preference is, this part of the NWB conversion procedure will vary depending on the individual researcher.</p>
<p>The initialisation process is completed by intialising the Matlab NWB classes by calling</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">generateCore</span><span class="p">;</span>
</pre></div>
</div>
<p>within the <code class="docutils literal notranslate"><span class="pre">convert2nwb.m</span></code> script file.</p>
<p>The conversion process then goes through every recording session and generates NWB files individually for each session inside the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. We start by creating an <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/NwbFile.html"><code class="docutils literal notranslate"><span class="pre">NWBFile</span></code></a> object and defining session metadata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">Assign</span> <span class="n">NWB</span> <span class="n">file</span> <span class="n">fields</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">NwbFile</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;session_description&#39;</span><span class="p">,</span> <span class="n">sessionDescription</span><span class="p">{</span><span class="n">iSess</span><span class="p">},</span><span class="o">...</span>
  <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">animalID</span> <span class="s1">&#39;_&#39;</span> <span class="n">sessionID</span><span class="p">{</span><span class="n">iSess</span><span class="p">}],</span> <span class="o">...</span>
  <span class="s1">&#39;session_start_time&#39;</span><span class="p">,</span> <span class="n">sessionStartTime</span><span class="p">{</span><span class="n">iSess</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;general_experimenter&#39;</span><span class="p">,</span> <span class="n">experimenter</span><span class="p">,</span> <span class="o">...</span> <span class="o">%</span> <span class="n">optional</span>
  <span class="s1">&#39;general_session_id&#39;</span><span class="p">,</span> <span class="n">sessionID</span><span class="p">{</span><span class="n">iSess</span><span class="p">},</span> <span class="o">...</span> <span class="o">%</span> <span class="n">optional</span>
  <span class="s1">&#39;general_institution&#39;</span><span class="p">,</span> <span class="n">institution</span><span class="p">,</span> <span class="o">...</span> <span class="o">%</span> <span class="n">optional</span>
  <span class="s1">&#39;general_related_publications&#39;</span><span class="p">,</span> <span class="n">publications</span><span class="p">,</span> <span class="o">...</span> <span class="o">%</span> <span class="n">optional</span>
  <span class="s1">&#39;general_notes&#39;</span><span class="p">,</span> <span class="n">sessionNotes</span><span class="p">{</span><span class="n">iSess</span><span class="p">},</span> <span class="o">...</span> <span class="o">%</span> <span class="n">optional</span>
  <span class="s1">&#39;general_lab&#39;</span><span class="p">,</span> <span class="n">lab</span><span class="p">);</span> <span class="o">%</span> <span class="n">optional</span>
</pre></div>
</div>
<p>Each file must have a <code class="docutils literal notranslate"><span class="pre">session_description</span></code> identifier and a <code class="docutils literal notranslate"><span class="pre">session_start_time</span></code> parameter. We then initialise the <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/Subject.html"><code class="docutils literal notranslate"><span class="pre">Subject</span></code></a> object and the metadata it contains:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">Create</span> <span class="n">subject</span> <span class="nb">object</span>
<span class="n">subject</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Subject</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">animalID</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">sex</span><span class="p">);</span>
<span class="n">nwb</span><span class="o">.</span><span class="n">general_subject</span> <span class="o">=</span> <span class="n">subject</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="construct-electrodes-table">
<span id="tutorials-silicon-probe-convert2nwb-matlab-electrodes-table"></span><h4>Construct Electrodes Table<a class="headerlink" href="#construct-electrodes-table" title="Permalink to this headline">#</a></h4>
<p>Storing extracellular electrophysiology data is not possible without defining the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table which is a <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+hdmf_common/DynamicTable.html"><code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code></a> object. We do it first by creating a <a class="reference external" href="https://uk.mathworks.com/help/matlab/tables.html">Matlab table array</a> using a code wrapped inside the <code class="docutils literal notranslate"><span class="pre">createElectrodeTable</span></code> function. We put the table generation code inside the function, because it is going to be reused for each probe. The function call for probe 1 is executed by the code below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">Create</span> <span class="n">electrode</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Info</span> <span class="n">about</span> <span class="n">each</span> <span class="n">recording</span> <span class="n">channel</span>
<span class="nb">input</span><span class="o">.</span><span class="n">iElectrode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">input</span><span class="o">.</span><span class="n">electrodeDescription</span> <span class="o">=</span> <span class="n">electrodeDescription</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">electrodeManufacturer</span> <span class="o">=</span> <span class="n">electrodeManufacturer</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">nShanks</span> <span class="o">=</span> <span class="n">nShanks</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">nChannelsPerShank</span> <span class="o">=</span> <span class="n">nChannelsPerShank</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">electrodeLocation</span> <span class="o">=</span> <span class="n">electrodeLocation</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span> <span class="o">=</span> <span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">sessionID</span> <span class="o">=</span> <span class="n">sessionID</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="nb">input</span><span class="o">.</span><span class="n">electrodeLabel</span> <span class="o">=</span> <span class="n">electrodeLabel</span><span class="p">{</span><span class="n">iSess</span><span class="p">};</span>
<span class="k">if</span> <span class="n">probeInserted</span><span class="p">{</span><span class="n">iSess</span><span class="p">}{</span><span class="nb">input</span><span class="o">.</span><span class="n">iElectrode</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="o">~</span><span class="n">isempty</span><span class="p">(</span><span class="n">endCh</span><span class="p">{</span><span class="n">iSess</span><span class="p">}{</span><span class="mi">1</span><span class="p">})</span>
  <span class="n">tbl1</span> <span class="o">=</span> <span class="n">createElectrodeTable</span><span class="p">(</span><span class="n">nwb</span><span class="p">,</span> <span class="nb">input</span><span class="p">);</span>
<span class="k">else</span>
  <span class="n">tbl1</span> <span class="o">=</span> <span class="p">[];</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The table array for the probe 1 is then created within the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">table</span> <span class="k">with</span> <span class="n">given</span> <span class="n">column</span> <span class="n">labels</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;channel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_local_index&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;imp&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;filtering&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_label&#39;</span><span class="p">,</span> <span class="s1">&#39;probe_label&#39;</span><span class="p">};</span>
<span class="n">tbl</span> <span class="o">=</span> <span class="n">cell2table</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">variables</span><span class="p">)),</span> <span class="s1">&#39;VariableNames&#39;</span><span class="p">,</span> <span class="n">variables</span><span class="p">);</span>

<span class="o">%</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">probe</span> <span class="n">device</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeDescription</span><span class="p">{</span><span class="n">iEl</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;manufacturer&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeManufacturer</span><span class="p">{</span><span class="n">iEl</span><span class="p">}</span> <span class="o">...</span>
  <span class="p">);</span>
<span class="n">nwb</span><span class="o">.</span><span class="n">general_devices</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s1">&#39;probe&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)],</span> <span class="n">device</span><span class="p">);</span>

<span class="k">for</span> <span class="n">iShank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">nSh</span><span class="p">{</span><span class="n">iEl</span><span class="p">}</span>
  
  <span class="o">%</span> <span class="n">Register</span> <span class="n">a</span> <span class="n">shank</span> <span class="n">electrode</span> <span class="n">group</span> <span class="p">(</span><span class="n">only</span> <span class="n">one</span> <span class="n">because</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">single</span> <span class="n">shank</span> <span class="n">probe</span><span class="p">)</span>
  <span class="n">electrode_group</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ElectrodeGroup</span><span class="p">(</span> <span class="o">...</span>
    <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;electrode group for probe&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)],</span> <span class="o">...</span>
    <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeLocation</span><span class="p">{</span><span class="n">iEl</span><span class="p">}{</span><span class="n">end</span><span class="p">},</span> <span class="o">...</span>
    <span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">untyped</span><span class="o">.</span><span class="n">SoftLink</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="o">...</span>
    <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">...</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="o">...</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span>
    <span class="s1">&#39;VariableNames&#39;</span><span class="p">,{</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">})</span> <span class="o">...</span>
    <span class="p">);</span>
  <span class="n">nwb</span><span class="o">.</span><span class="n">general_extracellular_ephys</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s1">&#39;probe&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)],</span> <span class="n">electrode_group</span><span class="p">);</span>
  <span class="n">group_object_view</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">untyped</span><span class="o">.</span><span class="n">ObjectView</span><span class="p">(</span><span class="n">electrode_group</span><span class="p">);</span>
  
  <span class="o">%</span> <span class="n">Populate</span> <span class="n">the</span> <span class="n">electrode</span> <span class="n">table</span>
  <span class="k">for</span> <span class="n">iCh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">nCh</span><span class="p">{</span><span class="n">iEl</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">iCh</span> <span class="o">&lt;</span> <span class="mi">10</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="n">str2double</span><span class="p">([</span><span class="nb">input</span><span class="o">.</span><span class="n">sessionID</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)</span> <span class="s1">&#39;00&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iCh</span><span class="p">)]);</span>
    <span class="n">elseif</span> <span class="n">iCh</span> <span class="o">&lt;</span> <span class="mi">99</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="n">str2double</span><span class="p">([</span><span class="nb">input</span><span class="o">.</span><span class="n">sessionID</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)</span> <span class="s1">&#39;0&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iCh</span><span class="p">)]);</span>
    <span class="k">else</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="n">str2double</span><span class="p">([</span><span class="nb">input</span><span class="o">.</span><span class="n">sessionID</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iCh</span><span class="p">)]);</span>
    <span class="n">end</span>
    <span class="n">channel_label</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;probe&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iEl</span><span class="p">)</span> <span class="s1">&#39;shank&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iShank</span><span class="p">)</span> <span class="s1">&#39;elec&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iCh</span><span class="p">)];</span>
    <span class="n">tbl</span> <span class="o">=</span> <span class="p">[</span><span class="n">tbl</span><span class="p">;</span> <span class="o">...</span>
      <span class="p">{</span><span class="n">channelID</span><span class="p">,</span> <span class="n">iCh</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="n">iCh</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="n">iCh</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeCoordinates</span><span class="p">{</span><span class="n">iEl</span><span class="p">}(</span><span class="n">iCh</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="o">...</span>
      <span class="n">NaN</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeLocation</span><span class="p">{</span><span class="n">iEl</span><span class="p">}{</span><span class="n">iCh</span><span class="p">},</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">group_object_view</span><span class="p">,</span> <span class="n">channel_label</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">electrodeLabel</span><span class="p">{</span><span class="n">iEl</span><span class="p">}}];</span> <span class="o">%</span><span class="c1">#ok&lt;*AGROW&gt;</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The code initialises an empty table with given column labels. It then records the probe <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/Device.html"><code class="docutils literal notranslate"><span class="pre">Device</span></code></a> (which is an object itself) inside the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> object. Next, we create an <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/ElectrodeGroup.html"><code class="docutils literal notranslate"><span class="pre">ElectrodeGroup</span></code></a> object which is used to define electrode groupings within the probe. In our case we have a single shank probe and, therefore, we define all recording channels to be part of a single group. Though, grouping on some other basis is possible. You may have noticed that the <code class="docutils literal notranslate"><span class="pre">device</span></code> property is set as a <code class="docutils literal notranslate"><span class="pre">Softlink</span></code> object which is used to link to an already existing NWB object (in our case) or to an object within an NWB file using a path. Similarly, <code class="docutils literal notranslate"><span class="pre">ElectrodeGroup</span></code> is used to create an ObjectView object which works in a very similar way to the SoftLink object, and which is later used in constructing the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table. The <code class="docutils literal notranslate"><span class="pre">position</span></code> property is a Matlab table array with columns being stereotaxic coordinates. Finally, the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table is filled in channel by channel (rows) with channel subtables.</p>
<p>The same procedure is then repeated for the probe 2. Finally, the combined table array is then converted into a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object using <code class="docutils literal notranslate"><span class="pre">util.table2nwb</span></code> function which also takes in the table description as the second argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tbl</span> <span class="o">=</span> <span class="p">[</span><span class="n">tbl1</span><span class="p">;</span> <span class="n">tbl2</span><span class="p">];</span>
<span class="n">electrode_table</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">table2nwb</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;all electrodes&#39;</span><span class="p">);</span>
<span class="n">nwb</span><span class="o">.</span><span class="n">general_extracellular_ephys_electrodes</span> <span class="o">=</span> <span class="n">electrode_table</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can add any number of custom columns to a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object and, therefore, you can expand an <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table object with any additional metadata you deem necessary.</p>
</div>
</section>
<section id="load-and-initialise-spiking-data">
<span id="tutorials-silicon-probe-convert2nwb-matlab-init-spiking-data"></span><h4>Load and Initialise Spiking Data<a class="headerlink" href="#load-and-initialise-spiking-data" title="Permalink to this headline">#</a></h4>
<p>The next line of code loads processed spiking data from the Matlab MAT file by calling the <code class="docutils literal notranslate"><span class="pre">getSpikes</span></code> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">spikes</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">derivedData</span><span class="p">]</span> <span class="o">=</span> <span class="n">getSpikes</span><span class="p">(</span><span class="n">derivedData</span><span class="p">,</span> <span class="n">animalID</span><span class="p">,</span> <span class="n">sessionID</span><span class="p">{</span><span class="n">iSess</span><span class="p">},</span> <span class="n">tbl</span><span class="p">);</span>
</pre></div>
</div>
<p>This is a custom function containing the loading algorithm that very much depends on the processed data structure stored inside the MAT file. I will not go into the detail of how the function runs as your own data is very likely to be structured differently. However, you are welcome to explore the code yourself as it is commented generously. It will suffice to say that the function outputs the <code class="docutils literal notranslate"><span class="pre">spikes</span></code> variable which is a 1-by-n cell array with unit spike times in seconds, where n is the number of units. Moreover, the function also outputs the <code class="docutils literal notranslate"><span class="pre">metadataTbl</span></code> variable which is a Matlab table array with rows corresponding to individual clusters (units) and columns to various metadata types describing unit properties, like <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">channel_index</span></code>, <code class="docutils literal notranslate"><span class="pre">channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_horz_position</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_vert_position</span></code>, <code class="docutils literal notranslate"><span class="pre">isi_violations</span></code>, <code class="docutils literal notranslate"><span class="pre">isolation_distance</span></code>, <code class="docutils literal notranslate"><span class="pre">area</span></code>, <code class="docutils literal notranslate"><span class="pre">probe_id</span></code>, and <code class="docutils literal notranslate"><span class="pre">electrode_group</span></code>. You can find the description of each of these properties in the <code class="docutils literal notranslate"><span class="pre">getSpikes</span></code> function definition.</p>
<p>Once the spike times are extracted, we convert them into <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+hdmf_common/VectorData.html">VectorData</a> and <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+hdmf_common/VectorIndex.html">VectorIndex</a> objects by executing the line below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">spike_times_vector</span><span class="p">,</span> <span class="n">spike_times_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_indexed_column</span><span class="p">(</span><span class="n">spikes</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spike_times_vector.data</span></code> property is simply a vector of spike times where unit spike times are consequtively arranged into this single vector grouped on a unit basis. Meanwhile, <code class="docutils literal notranslate"><span class="pre">spike_times_index.data</span></code> property is a vector of indices which are then used to index the end of corresponding unit spike times data (i.e., row breaks). In conjunction, VectorData and VectorIndex objects can be used to encode ragged arrays. Ragged arrays have rows with different number of columns. All units taken together and their spike times form such a ragged array which is illustrated in the figure below.</p>
<a class="reference internal image-reference" href="../_images/ragged-array.png" id="fig-gin-silicon-ragged-array"><img alt="../_images/ragged-array.png" class="align-center" id="fig-gin-silicon-ragged-array" src="../_images/ragged-array.png" style="width: 690px;" /></a>
<p>       <strong>Figure 4. Ragged Array</strong> <br />
       Original image taken from <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/ecephys.html">here</a>.</p>
</section>
<section id="load-waveforms">
<span id="tutorials-silicon-probe-convert2nwb-matlab-load-waveforms"></span><h4>Load Waveforms<a class="headerlink" href="#load-waveforms" title="Permalink to this headline">#</a></h4>
<p>Before converting spiking data we load unit waveforms. The waveforms data can also be stored as a ragged array, even as a double-indexed one. You can find more information <a class="reference external" href="https://nwb-schema.readthedocs.io/en/latest/format_description.html">here</a> on how to construct such arrays. In our case, the waveforms arrays are rather simple: we are only interested in average waveforms on the probe recording channel with the largest waveform amplitude. This data is stored in the <code class="docutils literal notranslate"><span class="pre">waveformMeans</span></code> variable which is a cell array of average waveforms with cells corresponding to individual units. The variable is constructed after loading and reshaping the waveforms located inside the <code class="docutils literal notranslate"><span class="pre">convert2nwbMatNpx/npx_raw_derived_data/M200324_MD/&lt;session-ID&gt;/waveforms.mat</span></code> files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">Load</span> <span class="ow">and</span> <span class="n">reshape</span> <span class="n">unit</span> <span class="n">waveforms</span>
<span class="o">...</span>
<span class="k">for</span> <span class="n">iWave</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">numel</span><span class="p">(</span><span class="n">waveformMeans</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">isempty</span><span class="p">(</span><span class="n">waveformMeans</span><span class="p">{</span><span class="n">iWave</span><span class="p">})</span>
    <span class="n">waveformMeans</span><span class="p">{</span><span class="n">iWave</span><span class="p">}</span> <span class="o">=</span> <span class="n">nan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nWaveformSamples</span><span class="p">);</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</section>
<section id="construct-units-table">
<span id="tutorials-silicon-probe-convert2nwb-matlab-units-table"></span><h4>Construct Units Table<a class="headerlink" href="#construct-units-table" title="Permalink to this headline">#</a></h4>
<p>In order to store spiking data and other related data, we construct the <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/Units.html"><code class="docutils literal notranslate"><span class="pre">units</span></code> table</a> which is, like the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table, a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object. As such it supports addition of additional metadata columns. The code that constructs the <code class="docutils literal notranslate"><span class="pre">units</span></code> table is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nwb</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Units</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;colnames&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span><span class="s1">&#39;local_cluster_id&#39;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="o">...</span>
  <span class="s1">&#39;peak_channel_index&#39;</span><span class="p">,</span><span class="s1">&#39;peak_channel_id&#39;</span><span class="p">,</span><span class="o">...</span> <span class="o">%</span> <span class="n">Provide</span> <span class="n">the</span> <span class="n">column</span> <span class="n">order</span><span class="o">.</span> <span class="n">All</span> <span class="n">column</span> <span class="n">names</span> <span class="n">have</span> <span class="n">to</span> <span class="n">be</span> <span class="n">defined</span> <span class="n">below</span>
  <span class="s1">&#39;local_peak_channel_id&#39;</span><span class="p">,</span><span class="s1">&#39;rel_horz_pos&#39;</span><span class="p">,</span><span class="s1">&#39;rel_vert_pos&#39;</span><span class="p">,</span><span class="o">...</span>
  <span class="s1">&#39;isi_violations&#39;</span><span class="p">,</span><span class="s1">&#39;isolation_distance&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">,</span><span class="s1">&#39;probe_id&#39;</span><span class="p">,</span><span class="o">...</span>
  <span class="s1">&#39;electrode_group&#39;</span><span class="p">,</span><span class="s1">&#39;spike_times&#39;</span><span class="p">,</span><span class="s1">&#39;spike_times_index&#39;</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Units table&#39;</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">ElementIdentifiers</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="o">...</span>
  <span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">1</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Unique cluster id&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;local_cluster_id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">2</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Local cluster id on the probe&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">{:,</span><span class="mi">3</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Cluster type: unit vs mua&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;peak_channel_index&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">4</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak channel row index in the electrode table&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;peak_channel_id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">5</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Unique ID of the channel with the largest cluster waveform amplitude&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;local_peak_channel_id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">6</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Local probe channel with the largest cluster waveform amplitude&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;rel_horz_pos&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">7</span><span class="p">})</span><span class="o">./</span><span class="mi">1000</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Probe-relative horizontal position in mm&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;rel_vert_pos&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">8</span><span class="p">})</span><span class="o">./</span><span class="mi">1000</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Probe tip-relative vertical position in mm&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;isi_violations&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">9</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Interstimulus interval violations (unit quality measure)&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;isolation_distance&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">metadata</span><span class="p">{:,</span><span class="mi">10</span><span class="p">}),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Cluster isolation distance (unit quality measure)&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">{:,</span><span class="mi">11</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Brain area where the unit is located. Internal thalamic &#39;</span> <span class="o">...</span>
  <span class="s1">&#39;nuclei divisions are not precise, because they are derived from unit locations on the probe.&#39;</span><span class="p">]),</span> <span class="o">...</span>
  <span class="s1">&#39;probe_id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">{:,</span><span class="mi">12</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Probe id where the unit is located&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;spike_times&#39;</span><span class="p">,</span> <span class="n">spike_times_vector</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;spike_times_index&#39;</span><span class="p">,</span> <span class="n">spike_times_index</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;electrode_group&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">{:,</span><span class="mi">13</span><span class="p">},</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Recording channel groups&#39;</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;waveform_mean&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">hdmf_common</span><span class="o">.</span><span class="n">VectorData</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">waveformMeans</span><span class="p">),</span> <span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Mean waveforms on the probe channel with the largest waveform amplitude. &#39;</span> <span class="o">...</span>
  <span class="s1">&#39;MUA waveforms are excluded. The order that waveforms are stored match the order of units in the unit table.&#39;</span><span class="p">])</span> <span class="o">...</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The property <code class="docutils literal notranslate"><span class="pre">colnames</span></code> specifies <code class="docutils literal notranslate"><span class="pre">units</span></code> table column names and should be used to indicate column order. The <code class="docutils literal notranslate"><span class="pre">description</span></code> property is simply used to describe what kind of information is stored in the table. When constructing the table you have to provide the <code class="docutils literal notranslate"><span class="pre">id</span></code> property which is the <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+hdmf_common/ElementIdentifiers.html">ElementIdentifiers</a> list object containing indices starting with 0 and used to identify <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> rows. Custom properties are passed in as VectorData objects with their own <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">description</span></code> properties. In the above code snippet these include <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">peak_channel_index</span></code>, <code class="docutils literal notranslate"><span class="pre">peak_channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_peak_channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_horz_pos</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_vert_pos</span></code>, <code class="docutils literal notranslate"><span class="pre">isi_violations</span></code>, <code class="docutils literal notranslate"><span class="pre">isolation_distance</span></code>, <code class="docutils literal notranslate"><span class="pre">area</span></code>, and <code class="docutils literal notranslate"><span class="pre">probe_id</span></code>. You can also pass in a few optional properties like <code class="docutils literal notranslate"><span class="pre">electrode_group</span></code> VectorData object which specifies an electrode group that each spike unit came from and <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+hdmf_common/DynamicTableRegion.html"><code class="docutils literal notranslate"><span class="pre">DynamicTableRegion</span></code></a> object used to reference the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table containing the electrodes that each spike unit came from, as well as other properties. Finally, we also pass in the <code class="docutils literal notranslate"><span class="pre">waveform_mean</span></code> property containing a matrix of mean unit waveforms as a VectorData object. The latter property will not be one of the table columns as it is not listed in the <code class="docutils literal notranslate"><span class="pre">colnames</span></code> property but it will be accessible via dot indexing.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>VectorData objects should not have cell arrays of integers (cell arrays of strings are fine) as their data property. During the NWB conversion they are not going to be encoded properly and will generate an error. You can use Matlab’s <code class="docutils literal notranslate"><span class="pre">cell2mat</span></code> function to convert them into regular number arrays.</p>
</div>
</section>
<section id="add-behavioural-module-pupil-area-size">
<span id="tutorials-silicon-probe-convert2nwb-matlab-pupil-area"></span><h4>Add Behavioural Module: Pupil Area Size<a class="headerlink" href="#add-behavioural-module-pupil-area-size" title="Permalink to this headline">#</a></h4>
<p>We load pupil area size data from the same file containing processed spiking data. We then convert this data into a <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/TimeSeries.html"><code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code></a> object which is designed to store any general purpose time series data. This object has a few mandatory properties, like <code class="docutils literal notranslate"><span class="pre">data</span></code>, <code class="docutils literal notranslate"><span class="pre">data_unit</span></code>, and <code class="docutils literal notranslate"><span class="pre">starting_time_rate</span></code>, and a few optional ones, like <code class="docutils literal notranslate"><span class="pre">timestamps</span></code>, <code class="docutils literal notranslate"><span class="pre">control</span></code>, <code class="docutils literal notranslate"><span class="pre">control_description</span></code>, and <code class="docutils literal notranslate"><span class="pre">description</span></code>. The <code class="docutils literal notranslate"><span class="pre">data</span></code> property can be stored as any 1-D, 2-D, 3-D, or 4-D array where the first dimension is time. We use it to store our <code class="docutils literal notranslate"><span class="pre">pupilAreaSize</span></code> data vector. The <code class="docutils literal notranslate"><span class="pre">data_unit</span></code> property has to be a string, while the <code class="docutils literal notranslate"><span class="pre">starting_time_rate</span></code> property is a scalar of <code class="docutils literal notranslate"><span class="pre">float32</span></code> type. The <code class="docutils literal notranslate"><span class="pre">timestamps</span></code> property should give data sampling times and should be stored as a unidimensional number array of <code class="docutils literal notranslate"><span class="pre">float64</span></code> type. The <code class="docutils literal notranslate"><span class="pre">control</span></code> property is used for labeling data samples with integers. The length of this array should be the same as the length of the first data dimension representing time. In our case I am using integers 0 and 1 to mark acceptable quality data. The meaning of these labels is provided by the <code class="docutils literal notranslate"><span class="pre">control_description</span></code> property which is a cell array of strings with cells describing labels in the increasing order. The full code that converts the pupil area size data into the appropriate form is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pupilAreaSize</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">(</span> <span class="o">...</span>
  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">pupilAreaSize</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="n">videoFrameTimes</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;data_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;pixels^2&#39;</span><span class="p">,</span> <span class="o">...</span>
  <span class="s1">&#39;starting_time_rate&#39;</span><span class="p">,</span> <span class="n">videoFrameRate</span><span class="p">,</span><span class="o">...</span>
  <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">uint8</span><span class="p">(</span><span class="n">acceptableSamples</span><span class="p">),</span><span class="o">...</span>
  <span class="s1">&#39;control_description&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;low quality samples that should be excluded from analyses&#39;</span><span class="p">;</span><span class="o">...</span>
  <span class="s1">&#39;acceptable quality samples&#39;</span><span class="p">},</span><span class="o">...</span>
  <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Pupil area size over the recording session measured in pixels^2. &#39;</span> <span class="o">...</span>
  <span class="s1">&#39;Acceptable quality period starting and ending times are given by data_continuity parameter. &#39;</span> <span class="o">...</span>
  <span class="s1">&#39;The full data range can be divided into multiple acceptable periods.&#39;</span><span class="p">]</span> <span class="o">...</span>
<span class="p">);</span>

<span class="n">pupilTracking</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PupilTracking</span><span class="p">(</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">,</span> <span class="n">pupilAreaSize</span><span class="p">);</span>
<span class="n">behaviorModule</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ProcessingModule</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;contains behavioral data&#39;</span><span class="p">);</span>
<span class="n">behaviorModule</span><span class="o">.</span><span class="n">nwbdatainterface</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PupilTracking&#39;</span><span class="p">,</span> <span class="n">pupilTracking</span><span class="p">);</span>
</pre></div>
</div>
<p>As you will notice, our <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object is assigned to a <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/PupilTracking.html"><code class="docutils literal notranslate"><span class="pre">PupilTracking</span></code></a> object which can hold one or more of the <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> objects. We then create a <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/ProcessingModule.html"><code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code></a> container object to store the bahavioural data. The final line creates a <code class="docutils literal notranslate"><span class="pre">nwbdatainterface.PupilTracking</span></code> property with our <code class="docutils literal notranslate"><span class="pre">PupilTracking</span></code> object within the <code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code> object.</p>
</section>
<section id="add-behavioural-module-total-facial-movement">
<span id="tutorials-silicon-probe-convert2nwb-matlab-movement"></span><h4>Add Behavioural Module: Total Facial Movement<a class="headerlink" href="#add-behavioural-module-total-facial-movement" title="Permalink to this headline">#</a></h4>
<p>The facial movement data conversion process into appropriate form for NWB storage is almost identical to the conversion process applied to the pupil area size data. First, we load the data and store it inside the <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object. The steps are identical. Next, we store our <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object inside the <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/+types/+core/BehavioralTimeSeries.html"><code class="docutils literal notranslate"><span class="pre">BehavioralTimeSeries</span></code></a> object designed for holding one or more <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">behavioralTimeSeries</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">BehavioralTimeSeries</span><span class="p">(</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">,</span> <span class="n">totalFaceMovement</span><span class="p">);</span>
</pre></div>
</div>
<p>We then create a <code class="docutils literal notranslate"><span class="pre">nwbdatainterface.BehavioralTimeSeries</span></code> property with our <code class="docutils literal notranslate"><span class="pre">BehavioralTimeSeries</span></code> object within the <code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code> container object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">behaviorModule</span><span class="o">.</span><span class="n">nwbdatainterface</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;BehavioralTimeSeries&#39;</span><span class="p">,</span> <span class="n">behavioralTimeSeries</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, we create the behaviour module within the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nwb</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;behavior&#39;</span><span class="p">,</span> <span class="n">behaviorModule</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="save-nwb-file">
<span id="tutorials-silicon-probe-convert2nwb-matlab-save"></span><h4>Save NWB File<a class="headerlink" href="#save-nwb-file" title="Permalink to this headline">#</a></h4>
<p>We call the <code class="docutils literal notranslate"><span class="pre">nwbExport</span></code> function to save our data in the NWB format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">iSess</span> <span class="o">&lt;</span> <span class="mi">10</span>
  <span class="n">nwbExport</span><span class="p">(</span><span class="n">nwb</span><span class="p">,</span> <span class="p">[</span><span class="n">animalDerivedDataFolderNWB</span> <span class="n">filesep</span> <span class="s1">&#39;ecephys_session_0&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iSess</span><span class="p">)</span> <span class="s1">&#39;.nwb&#39;</span><span class="p">]);</span>
<span class="k">else</span>
  <span class="n">nwbExport</span><span class="p">(</span><span class="n">nwb</span><span class="p">,</span> <span class="p">[</span><span class="n">animalDerivedDataFolderNWB</span> <span class="n">filesep</span> <span class="s1">&#39;ecephys_session_&#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="n">iSess</span><span class="p">)</span> <span class="s1">&#39;.nwb&#39;</span><span class="p">]);</span>
<span class="n">end</span>
</pre></div>
</div>
</section>
<section id="read-nwb-file">
<span id="tutorials-silicon-probe-convert2nwb-matlab-read"></span><h4>Read NWB File<a class="headerlink" href="#read-nwb-file" title="Permalink to this headline">#</a></h4>
<p>Now if you want to open the NWB file that you just saved in Matlab, you can issue a command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nwb2</span> <span class="o">=</span> <span class="n">nwbRead</span><span class="p">(</span><span class="s1">&#39;ecephys_session_01.nwb&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>which will read the file passively. The action is fast and it does not load all of the data at once but rather make it readily accessible. This is useful as it allows you to read data selectively without loading the entire file content into the computer memory.</p>
<p>If you want to read the entire unit table which has all unit spiking data and associated metadata, the easiest way is to issue a command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unitsTable</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">loadAll</span><span class="o">.</span><span class="n">toTable</span><span class="p">();</span>
</pre></div>
</div>
<p>which will convert the <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object into a Matlab table array. The latter is a common Matlab data type and can be manipulated easily using regular Matlab syntax and indexing.</p>
<p>In contrast, if you are interested in a single unit data, you can load it using the following line of code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unitRow</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>To load only spiking data for the same unit, the following line of code will do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unitRowSpikeTimes</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">spike_times</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
</pre></div>
</div>
<p>If you want to load mean unit waveforms, the following line of code will load them as a floating-point number array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unitsWaveforms</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">waveform_mean</span><span class="o">.</span><span class="n">loadAll</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
</pre></div>
</div>
<p>Meanwhile, behavioural data can be accessed by running the code below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pupilAreaSize</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;behavior&#39;</span><span class="p">)</span><span class="o">.</span> <span class="o">...</span>
    <span class="n">nwbdatainterface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PupilTracking&#39;</span><span class="p">)</span><span class="o">.</span> <span class="o">...</span>
    <span class="n">timeseries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">(:);</span>

<span class="n">totalFacialMovement</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;behavior&#39;</span><span class="p">)</span><span class="o">.</span> <span class="o">...</span>
    <span class="n">nwbdatainterface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BehavioralTimeSeries&#39;</span><span class="p">)</span><span class="o">.</span> <span class="o">...</span>
    <span class="n">timeseries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">(:);</span>
</pre></div>
</div>
<p>Other associated behavioural properties can be accessed by replacing the <code class="docutils literal notranslate"><span class="pre">data</span></code> property by <code class="docutils literal notranslate"><span class="pre">timestamps</span></code> or <code class="docutils literal notranslate"><span class="pre">control</span></code> and so on.</p>
<p>Some metadata is often directly available as properties of the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> object, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sessionDescription</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">session_description</span><span class="p">;</span>
</pre></div>
</div>
<p>Subject metadata is available via the command, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">animalID</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">general_subject</span><span class="o">.</span><span class="n">subject_id</span><span class="p">;</span>
</pre></div>
</div>
<p>While the electrode metadata can be accessed in the following way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">electrodesTable</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">general_extracellular_ephys_electrodes</span><span class="o">.</span><span class="n">toTable</span><span class="p">();</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table is a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object and, therefore, methods of accessing it are the same as those discussed for accessing the <code class="docutils literal notranslate"><span class="pre">units</span></code> table. For more detailed account of how you can access and manipulate <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> objects refer to an external <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/dynamic_tables.html">MatNWB DynamicTables Tutorial</a>.</p>
</section>
<section id="validate-nwb-file">
<span id="tutorials-silicon-probe-convert2nwb-matlab-validate"></span><h4>Validate NWB File<a class="headerlink" href="#validate-nwb-file" title="Permalink to this headline">#</a></h4>
<p>MatNWB does not provide its own NWB file validator. However, you can validate NWB files generated using Matlab in Python. For instructions on how to do it, refer to the corresponding <a class="reference internal" href="#tutorials-silicon-probe-convert2nwb-py-validate"><span class="std std-ref">PyNWB validation section</span></a> of the tutorial.</p>
</section>
<section id="resources">
<span id="tutorials-silicon-probe-convert2nwb-matlab-resources"></span><h4>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">#</a></h4>
<p>This section explained how you can use Matlab to convert your processed spiking and behavioural data into NWB files. It is not an exhaustive overview of Matnwb toolbox extracellular electrophysiology functionality. There are other potential use cases involving local field potentials (LFPs) and different types of behavioural data. There is a number of externally available tutorials covering some aspects of converting data obtained in extracellular electrophysiology experiments to the NWB file format using Matlab:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/intro.html">Intro to NWB Tutorial</a></p></li>
<li><p><a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/ecephys.html">NWB Extracellular Electrophysiology Tutorial</a></p></li>
<li><p><a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/behavior.html">Behavior Data Tutorial</a></p></li>
<li><p><a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/dynamic_tables.html">MatNWB DynamicTables Tutorial</a></p></li>
<li><p><a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/doc/index.html">MatNWB API Documentation</a></p></li>
<li><p><a class="reference external" href="https://nwb-schema.readthedocs.io/en/latest/index.html">NWB Schema Overview</a></p></li>
</ul>
</section>
</section>
<section id="convert-to-nwb-using-python">
<span id="tutorials-silicon-probe-convert2nwb-py"></span><h3>Convert to NWB Using Python<a class="headerlink" href="#convert-to-nwb-using-python" title="Permalink to this headline">#</a></h3>
<section id="install-pynwb">
<span id="tutorials-silicon-probe-convert2nwb-py-install"></span><h4>Install PyNWB<a class="headerlink" href="#install-pynwb" title="Permalink to this headline">#</a></h4>
<p>To convert your extracellular electrophysiology data, you will need to install PyNWB first. To do so, type in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pynwb</span>
</pre></div>
</div>
<p>Now you’re ready to start working with PyNWB. The full installation instructions are available <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/install_users.html">here</a>.</p>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-record-metadata">
<span id="id1"></span><h4>Record Metadata<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-record-metadata" title="Permalink to this headline">#</a></h4>
<p>Just like in the Matlab tutorial, we have prepared example repositories containing single session extracellular physiology recording data collected with <a class="reference external" href="https://gin.g-node.org/dervinism/convert2nwbPyNnx">Neuronexus</a> and <a class="reference external" href="https://gin.g-node.org/dervinism/convert2nwbPyNpx">Neuropixels</a> probes and Python scripts that would convert that data to NWB format. They can be used to familiarise with the Python NWB conversion scheme for spiking data combined with behavioural measurements. Both conversion scripts are very similar and, thus, we will focus on the Neuropixels use case.</p>
<p>To donwload the Neuropixels repository, type in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">get</span> <span class="n">dervinism</span><span class="o">/</span><span class="n">convert2nwbPyNpx</span>
<span class="n">cd</span> <span class="n">convert2nwbPyNpx</span>
<span class="n">gin</span> <span class="n">get</span><span class="o">-</span><span class="n">content</span>
</pre></div>
</div>
<p>It will take some time to download the full repository. Once the download is complete you can open the <code class="docutils literal notranslate"><span class="pre">convert2nwb.py</span></code> file and and execute it right away. The script would load derived spiking and behavioural data from <code class="docutils literal notranslate"><span class="pre">convert2nwbPyNpx/npx_derived_data/M200324_MD/M200324_MD.mat</span></code> file, convert it to the NWB format, and save it inside <code class="docutils literal notranslate"><span class="pre">convert2nwbPyNpx/npx_derived_data_nwb</span></code> folder as <code class="docutils literal notranslate"><span class="pre">ecephys_session_01.nwb</span></code> file.</p>
<p>We will now analyse the conversion script in more detail. The script starts by importing general and <code class="docutils literal notranslate"><span class="pre">pynwb</span></code> module dependencies, as well as custom functions located inside the <code class="docutils literal notranslate"><span class="pre">localFunctions.py</span></code> module file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">dateutil.tz</span> <span class="kn">import</span> <span class="n">tzlocal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pynwb</span> <span class="kn">import</span> <span class="n">NWBFile</span><span class="p">,</span> <span class="n">NWBHDF5IO</span><span class="p">,</span> <span class="n">TimeSeries</span>
<span class="kn">from</span> <span class="nn">pynwb.behavior</span> <span class="kn">import</span> <span class="n">PupilTracking</span><span class="p">,</span> <span class="n">BehavioralTimeSeries</span>
<span class="kn">from</span> <span class="nn">pynwb.core</span> <span class="kn">import</span> <span class="n">DynamicTable</span>
<span class="kn">from</span> <span class="nn">pynwb.ecephys</span> <span class="kn">import</span> <span class="n">ElectricalSeries</span><span class="p">,</span> <span class="n">LFP</span>
<span class="kn">from</span> <span class="nn">pynwb.file</span> <span class="kn">import</span> <span class="n">Subject</span>

<span class="kn">from</span> <span class="nn">localFunctions</span> <span class="kn">import</span> <span class="n">createElectrodeTable</span><span class="p">,</span> <span class="n">array2list</span><span class="p">,</span> <span class="n">getSpikes</span><span class="p">,</span> <span class="n">reshapeWaveforms</span><span class="p">,</span> <span class="n">concatenateMat</span><span class="p">,</span> <span class="n">parsePeriod</span><span class="p">,</span> <span class="n">markQualitySamples</span>
</pre></div>
</div>
<p>These are not all modules that we need. Some of them are loaded inside parameter files. These other modules include: <code class="docutils literal notranslate"><span class="pre">pathlib</span></code>, <code class="docutils literal notranslate"><span class="pre">os</span></code>, <code class="docutils literal notranslate"><span class="pre">re</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code>, <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, <code class="docutils literal notranslate"><span class="pre">h5py</span></code>, and <code class="docutils literal notranslate"><span class="pre">scipy</span></code> among others.</p>
<p>We then execute three parameter files to initiate the conversion environment. The first parameter file <code class="docutils literal notranslate"><span class="pre">nwbParams.py</span></code> contains the most general type of parameters that apply to all animals and recording sessions of the experiment, like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">projectName</span> <span class="o">=</span> <span class="s1">&#39;Brainwide Infraslow Activity Dynamics&#39;</span>
<span class="n">experimenter</span> <span class="o">=</span> <span class="s1">&#39;Martynas Dervinis&#39;</span>
<span class="n">institution</span> <span class="o">=</span> <span class="s1">&#39;University of Leicester&#39;</span>
<span class="n">publications</span> <span class="o">=</span> <span class="s1">&#39;In preparation&#39;</span>
<span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Michael Okun lab&#39;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;neuropixels&#39;</span>
<span class="n">videoFrameRate</span> <span class="o">=</span> <span class="mf">25.0</span> <span class="c1"># Hz</span>
</pre></div>
</div>
<p>The names of most of these parameters are self-explanatory. The <code class="docutils literal notranslate"><span class="pre">videoFrameRate</span></code> variable contains the camera’s frame rate recording the animal’s pupil. There are also input and output folders which are initialised as global variables and defined at the bottom of the parameter file. They include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rawDataFolder</span></code> which contains probe recording channel maps and unit waveform files;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">derivedDataFolder</span></code> which contains processed spiking data;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">derivedDataFolderNWB</span></code> which is the output folder where converted NWB files are saved.</p></li>
</ul>
<p>As the name implies, <code class="docutils literal notranslate"><span class="pre">nwbAnimalParams.py</span></code> file contains parameters specific to a particular animal and common to all recording sessions for that animal. They include:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">animalID</span> <span class="o">=</span> <span class="s1">&#39;M200324_MD&#39;</span>
<span class="n">dob</span> <span class="o">=</span> <span class="s1">&#39;20200206&#39;</span>
<span class="o">...</span>
<span class="n">strain</span> <span class="o">=</span> <span class="s1">&#39;C57BL/6J&#39;</span>
<span class="n">sex</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
<span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;Mus musculus&#39;</span>
<span class="n">weight</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;025&#39;</span> <span class="c1"># Animal testing order.</span>
</pre></div>
</div>
<p>Names of these parameters are self-explanatory. The script also defines input and output folders specifically for the animal of interest.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nwbSessionParams.py</span></code> file stores parameters about recording sessions. Some of these parameters are defined at the top of the file explicitly for each individual session and some even explicitly for each recording probe, like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sessionID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20200324161349&#39;</span><span class="p">]</span>
<span class="n">sessionDescription</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;anaesthesia&#39;</span><span class="p">]</span>
<span class="n">sessionNotes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span>
<span class="n">endCh</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sessionID</span><span class="p">))]</span>
<span class="n">endCh</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">88</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">342</span><span class="p">,</span> <span class="mi">384</span><span class="p">])</span> <span class="c1"># Corresponding probe end channels starting from the tip of the probe. Corresponding and previous end channels are used to work out probe channels that reside in the corresponding brain area.</span>
<span class="n">endCh</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">41</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">384</span><span class="p">])</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">for</span></code> loop that follows next sets the remaining parameters that are common across recording sessions, like <code class="docutils literal notranslate"><span class="pre">electrodeName</span></code>, <code class="docutils literal notranslate"><span class="pre">electrodeDescription</span></code>, <code class="docutils literal notranslate"><span class="pre">electrodeManufacturer</span></code>, <code class="docutils literal notranslate"><span class="pre">nShanks</span></code> (number of probe shanks), <code class="docutils literal notranslate"><span class="pre">nChannelsPerShank</span></code> (number of recording channels per shank), <code class="docutils literal notranslate"><span class="pre">nCh</span></code> (total number of probe channels), <code class="docutils literal notranslate"><span class="pre">areas</span></code> (brain areas that probes span), <code class="docutils literal notranslate"><span class="pre">electrodeCoordinates</span></code> (electrode insertion coordinates), <code class="docutils literal notranslate"><span class="pre">electrodeLabel</span></code>, and <code class="docutils literal notranslate"><span class="pre">electrodeImplantationType</span></code> (i.e., acute or chronic).</p>
<p>Most of the parameters defined in the three parameter files comprise metadata. The way you define your metadata may be different. For example, you may have your own custom scripts that contain the metadata or you may store your metadata in files organised according to one of standard neuroscientific metadata formats like <a class="reference external" href="http://g-node.github.io/python-odml/">odML</a>. Whichever your preference is, this part of the NWB conversion procedure will vary depending on the individual researcher.</p>
<p>The conversion process then goes through every recording session and generates NWB files individually for each session inside the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop of the <code class="docutils literal notranslate"><span class="pre">convert2nwb.py</span></code> file. We start by creating an <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html#pynwb.file.NWBFile"><code class="docutils literal notranslate"><span class="pre">NWBFile</span></code></a> object and defining session metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign NWB file fields</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">NWBFile</span><span class="p">(</span>
  <span class="n">session_description</span> <span class="o">=</span> <span class="n">sessionDescription</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="n">identifier</span> <span class="o">=</span> <span class="n">animalID</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sessionID</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span> 
  <span class="n">session_start_time</span> <span class="o">=</span> <span class="n">sessionStartTime</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span> 
  <span class="n">experimenter</span> <span class="o">=</span> <span class="n">experimenter</span><span class="p">,</span>  <span class="c1"># optional</span>
  <span class="n">session_id</span> <span class="o">=</span> <span class="n">sessionID</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>  <span class="c1"># optional</span>
  <span class="n">institution</span> <span class="o">=</span> <span class="n">institution</span><span class="p">,</span>  <span class="c1"># optional</span>
  <span class="n">related_publications</span> <span class="o">=</span> <span class="n">publications</span><span class="p">,</span>  <span class="c1"># optional</span>
  <span class="n">notes</span> <span class="o">=</span> <span class="n">sessionNotes</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>  <span class="c1"># optional</span>
  <span class="n">lab</span> <span class="o">=</span> <span class="n">lab</span><span class="p">)</span> <span class="c1"># optional</span>
</pre></div>
</div>
<p>Each file must have a <code class="docutils literal notranslate"><span class="pre">session_description</span></code> identifier and a <code class="docutils literal notranslate"><span class="pre">session_start_time</span></code> parameter. We then initialise the <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html#pynwb.file.Subject"><code class="docutils literal notranslate"><span class="pre">Subject</span></code></a> object and the metadata it contains:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subject object</span>
<span class="n">nwb</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">Subject</span><span class="p">(</span>
  <span class="n">subject_id</span> <span class="o">=</span> <span class="n">animalID</span><span class="p">,</span>
  <span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">,</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">,</span>
  <span class="n">species</span> <span class="o">=</span> <span class="n">species</span><span class="p">,</span>
  <span class="n">sex</span> <span class="o">=</span> <span class="n">sex</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-electrodes-table">
<span id="id2"></span><h4>Construct Electrodes Table<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-electrodes-table" title="Permalink to this headline">#</a></h4>
<p>Storing extracellular electrophysiology data is not possible without defining the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table which is a <a class="reference external" href="https://hdmf.readthedocs.io/en/stable/hdmf.common.table.html#hdmf.common.table.DynamicTable"><code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code></a> object. We do it first by creating a numpy array object using a code wrapped inside the <code class="docutils literal notranslate"><span class="pre">createElectrodeTable</span></code> function. We put the table generation code inside the function, because it is going to be reused for each probe. The function call for probe 1 is executed by the code below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;iElectrode&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;electrodeDescription&quot;</span><span class="p">:</span> <span class="n">electrodeDescription</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;electrodeManufacturer&quot;</span><span class="p">:</span> <span class="n">electrodeManufacturer</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;nShanks&quot;</span><span class="p">:</span> <span class="n">nShanks</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;nChannelsPerShank&quot;</span><span class="p">:</span> <span class="n">nChannelsPerShank</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;electrodeLocation&quot;</span><span class="p">:</span> <span class="n">electrodeLocation</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;electrodeCoordinates&quot;</span><span class="p">:</span> <span class="n">electrodeCoordinates</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;sessionID&quot;</span><span class="p">:</span> <span class="n">sessionID</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span>
  <span class="s2">&quot;electrodeLabel&quot;</span><span class="p">:</span> <span class="n">electrodeLabel</span><span class="p">[</span><span class="n">iSess</span><span class="p">]}</span>
<span class="k">if</span> <span class="n">probeInserted</span><span class="p">[</span><span class="n">iSess</span><span class="p">][</span><span class="nb">input</span><span class="p">[</span><span class="s2">&quot;iElectrode&quot;</span><span class="p">]]</span> <span class="ow">and</span> <span class="n">endCh</span><span class="p">[</span><span class="n">iSess</span><span class="p">][</span><span class="nb">input</span><span class="p">[</span><span class="s2">&quot;iElectrode&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
  <span class="p">(</span><span class="n">tbl1</span><span class="p">,</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span><span class="p">)</span> <span class="o">=</span> <span class="n">createElectrodeTable</span><span class="p">(</span><span class="n">nwb</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">tbl1</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">columnLabels</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">columnDescription</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>The table numpy array for the probe 1 is then created within the function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parse input</span>
<span class="n">iEl</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;iElectrode&quot;</span><span class="p">]</span>
<span class="n">nSh</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;nShanks&quot;</span><span class="p">]</span>
<span class="n">nCh</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;nChannelsPerShank&quot;</span><span class="p">]</span>

<span class="c1"># Create a table with given column labels</span>
<span class="n">columnLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_local_index&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;imp&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;filtering&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_label&#39;</span><span class="p">,</span> <span class="s1">&#39;probe_label&#39;</span><span class="p">]</span>
<span class="n">columnDescription</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;A unnique probe channel ID formed by combining session ID, probe reference number, and channel number relative to the tip of the probe.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel index relative to the tip of the probe. Channel indices are only unique within a probe.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel AP brain surface coordinate (probe inisertion location mm).&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel ML brain surface coordinate (probe inisertion location mm).&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel location relative to the tip of the probe in mm.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel impedance.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel brain area location.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Type of LFP filtering applied.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel electrode group (e.g., shank 1).&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Channel_label.&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Probe_label.&#39;</span>
<span class="p">]</span>
<span class="n">tbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columnLabels</span><span class="p">)))</span>

<span class="c1"># Register the probe device</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">create_device</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;probe&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
  <span class="n">description</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeDescription&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">],</span>
  <span class="n">manufacturer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeManufacturer&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">])</span>

<span class="k">for</span> <span class="n">iShank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nSh</span><span class="p">[</span><span class="n">iEl</span><span class="p">]):</span>
  
  <span class="c1"># Register a shank electrode group (only one because this is a single shank probe)</span>
  <span class="n">electrode_group</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">create_electrode_group</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;probe&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;electrode group for probe&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">location</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeLocation&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span>
    <span class="n">position</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeCoordinates&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  
  <span class="c1"># Populate the electrode table</span>
  <span class="k">for</span> <span class="n">iCh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nCh</span><span class="p">[</span><span class="n">iEl</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">iCh</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s2">&quot;sessionID&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;00&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iCh</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">iCh</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s2">&quot;sessionID&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iCh</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">channelID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s2">&quot;sessionID&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iCh</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">channel_label</span> <span class="o">=</span> <span class="s1">&#39;probe&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;shank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iShank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;elec&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iCh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
      <span class="n">channelID</span><span class="p">,</span> <span class="n">iCh</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeCoordinates&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="n">iCh</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeCoordinates&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="n">iCh</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeCoordinates&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="n">iCh</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
      <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeLocation&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">][</span><span class="n">iCh</span><span class="p">],</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">electrode_group</span><span class="p">,</span> <span class="n">channel_label</span><span class="p">,</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;electrodeLabel&quot;</span><span class="p">][</span><span class="n">iEl</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  
<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span>
</pre></div>
</div>
<p>The code initialises an empty table with given column labels. It then records the probe <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.device.html?highlight=create_device"><code class="docutils literal notranslate"><span class="pre">Device</span></code></a> inside the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> object (see the method documentation <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=create_device#pynwb.file.NWBFile.create_device">here</a>). Next, we create an <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.ecephys.html#pynwb.ecephys.ElectrodeGroup"><code class="docutils literal notranslate"><span class="pre">ElectrodeGroup</span></code></a> object which is used to define electrode groupings within the probe (see the method documentation <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=create_electrode_group#pynwb.file.NWBFile.create_electrode_group">here</a>). In our case we have a single shank probe and, therefore, we define all recording channels to be part of a single group. Though, grouping on some other basis is possible. We set the <code class="docutils literal notranslate"><span class="pre">device</span></code> property to the previously created <code class="docutils literal notranslate"><span class="pre">Device</span></code> object. The <code class="docutils literal notranslate"><span class="pre">location</span></code> property defines the location on the cortical surface where the probe was inserted, while the <code class="docutils literal notranslate"><span class="pre">position</span></code> property is a numpy array with columns being stereotaxic coordinates. Finally, the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table is filled in channel by channel (rows) with channel subtables.</p>
<p>The same procedure is then repeated for the probe 2. The numpy arrays for the two probes are then combined and converted into a column list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl1</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl2</span><span class="p">):</span>
  <span class="n">tbl</span> <span class="o">=</span> <span class="n">array2list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl1</span><span class="p">,</span> <span class="n">tbl2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl1</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl2</span><span class="p">):</span>
  <span class="n">tbl</span> <span class="o">=</span> <span class="n">array2list</span><span class="p">(</span><span class="n">tbl1</span><span class="p">,</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span><span class="p">)</span>
<span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl1</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl2</span><span class="p">):</span>
  <span class="n">tbl</span> <span class="o">=</span> <span class="n">array2list</span><span class="p">(</span><span class="n">tbl2</span><span class="p">,</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Finally, this list is converted into an <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object. We start by defining <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table columns using <code class="docutils literal notranslate"><span class="pre">add_electrode_column</span></code> <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> method (documented <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=add_electrode_column#pynwb.file.NWBFile.add_electrode_column">here</a>). Next we add table entries electrode by electrode using the <code class="docutils literal notranslate"><span class="pre">add_electrode</span></code> method (documented <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=add_electrode_column#pynwb.file.NWBFile.add_electrode">here</a>). We finish by converting the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table into a pandas <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html"><code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> object</a> by calling the <code class="docutils literal notranslate"><span class="pre">to_dataframe</span></code> <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> method (documented <a class="reference external" href="https://hdmf.readthedocs.io/en/stable/hdmf.common.table.html#hdmf.common.table.DynamicTable.to_dataframe">here</a>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">iColumn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columnLabels</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">columnLabels</span><span class="p">[</span><span class="n">iColumn</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;location&#39;</span> <span class="ow">and</span> <span class="n">columnLabels</span><span class="p">[</span><span class="n">iColumn</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
      <span class="n">nwb</span><span class="o">.</span><span class="n">add_electrode_column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">columnLabels</span><span class="p">[</span><span class="n">iColumn</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="n">columnDescription</span><span class="p">[</span><span class="n">iColumn</span><span class="p">])</span>
  
  <span class="k">for</span> <span class="n">iElec</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
    <span class="n">nwb</span><span class="o">.</span><span class="n">add_electrode</span><span class="p">(</span>
      <span class="n">channel_id</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">channel_local_index</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">x</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">y</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">z</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">]),</span>
      <span class="n">imp</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">location</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">filtering</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">group</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">channel_label</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">],</span>
      <span class="n">probe_label</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iElec</span><span class="p">]</span>
    <span class="p">)</span>

  <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can add any number of custom columns to a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object and, therefore, you can expand an <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table object with any additional metadata you deem necessary.</p>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-init-spiking-data">
<span id="id3"></span><h4>Load and Initialise Spiking Data<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-init-spiking-data" title="Permalink to this headline">#</a></h4>
<p>The next line of code loads processed spiking data from the Matlab MAT file by calling the <code class="docutils literal notranslate"><span class="pre">getSpikes</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">derivedData</span><span class="p">,</span> <span class="n">columnLabels</span><span class="p">,</span> <span class="n">columnDescription</span><span class="p">)</span> <span class="o">=</span> <span class="n">getSpikes</span><span class="p">(</span><span class="n">derivedData</span><span class="p">,</span> <span class="n">animalID</span><span class="p">,</span> <span class="n">sessionID</span><span class="p">[</span><span class="n">iSess</span><span class="p">],</span> <span class="n">tbl</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a custom function containing the loading algorithm that very much depends on the processed data structure stored inside the MAT file. I will not go into the detail of how the function runs as your own data is very likely to be structured differently. However, you are welcome to explore the code yourself as it is commented generously. It will suffice to say that the function outputs the <code class="docutils literal notranslate"><span class="pre">spikes</span></code> variable which is a a 1-by-n list of numpy arrays of unit spike times in seconds, where n is the number of units. Moreover, the function also outputs the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> variable which is a numpy array with rows corresponding to individual clusters (units) and columns to various metadata types describing unit properties, like <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_cluster_id</span></code>, <code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">peak_channel_index</span></code>, <code class="docutils literal notranslate"><span class="pre">peak_channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">local_peak_channel_id</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_horz_position</span></code>, <code class="docutils literal notranslate"><span class="pre">rel_vert_position</span></code>, <code class="docutils literal notranslate"><span class="pre">isi_violations</span></code>, <code class="docutils literal notranslate"><span class="pre">isolation_distance</span></code>, <code class="docutils literal notranslate"><span class="pre">area</span></code>, <code class="docutils literal notranslate"><span class="pre">probe_id</span></code>, and <code class="docutils literal notranslate"><span class="pre">electrode_group</span></code>. You can find the description of each of these properties inside the <code class="docutils literal notranslate"><span class="pre">getSpikes</span></code> function definition.</p>
<p>For convenience and computational efficiency, the function also outputs the already loaded MAT file which can be reused later (the <code class="docutils literal notranslate"><span class="pre">derivedData</span></code> variable). The column labels of the metadata array and their descriptions are also provided as <code class="docutils literal notranslate"><span class="pre">columnLabels</span></code> and <code class="docutils literal notranslate"><span class="pre">columnDescription</span></code> variables, respectively.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spike times are stored as a ragged array inside the NWB file. Because each unit has a different number of spikes, spiking data from all units are pooled together into a single vector but spikes are grouped on the unit basis. An index vector is constructed and stored together inside the NWB file indexing final spikes of each unit (i.e., row breaks of the initial numpy array). You can read more about ragged arrays <a class="reference external" href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/ecephys.html">here</a>.</p>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-load-waveforms">
<span id="id4"></span><h4>Load Waveforms<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-load-waveforms" title="Permalink to this headline">#</a></h4>
<p>Before converting spiking data we load unit waveforms. The waveforms data can also be stored as a ragged array, even as a double-indexed one. You can find more information <a class="reference external" href="https://nwb-schema.readthedocs.io/en/latest/format_description.html">here</a> on how to construct such arrays. In our case, the waveforms arrays are rather simple: we are only interested in average waveforms on the probe recording channel with the largest waveform amplitude. This data is stored in the <code class="docutils literal notranslate"><span class="pre">waveformMeans</span></code> variable which is a numpy array of average waveforms with rows corresponding to individual units (MUAs are stored as NANs). The variable is constructed after loading and reshaping the waveforms located inside the <code class="docutils literal notranslate"><span class="pre">convert2nwbPyNpx/npx_raw_derived_data/M200324_MD/&lt;session-ID&gt;/waveforms.mat</span></code> files by calling the <code class="docutils literal notranslate"><span class="pre">reshapeWaveforms</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data fields</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">waveforms</span><span class="p">):</span>
  <span class="n">maxWaveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waveforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxWaveforms&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
  <span class="n">cluIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waveforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluIDs&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">maxWaveforms</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">cluIDs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Load waveforms</span>
<span class="n">metadataInds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">metadata</span><span class="p">[:,</span><span class="mi">11</span><span class="p">],</span> <span class="s1">&#39;probe&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iEl</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadataInds</span><span class="p">]</span>
<span class="n">waveformsMean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxWaveforms</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxWaveforms</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
  <span class="n">nWaveformSamples</span> <span class="o">=</span> <span class="n">maxWaveforms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">nWaveformSamples</span> <span class="o">=</span> <span class="mi">200</span>

<span class="k">for</span> <span class="n">iUnit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluIDs</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
    <span class="n">waveformsMean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxWaveforms</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">waveformsMean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">nWaveformSamples</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>

<span class="k">return</span> <span class="n">waveformsMean</span>
</pre></div>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-units-table">
<span id="id5"></span><h4>Construct Units Table<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-units-table" title="Permalink to this headline">#</a></h4>
<p>In order to store spiking data and other related data, we construct the <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.misc.html#pynwb.misc.Units"><code class="docutils literal notranslate"><span class="pre">units</span></code> table</a> which is, like the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table, a <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object. As such it supports addition of extra metadata columns. The code that constructs the <code class="docutils literal notranslate"><span class="pre">units</span></code> table is shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">iColumn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columnLabels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">nwb</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">columnLabels</span><span class="p">[</span><span class="n">iColumn</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="n">columnDescription</span><span class="p">[</span><span class="n">iColumn</span><span class="p">])</span>
<span class="k">for</span> <span class="n">iUnit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">)):</span>
  <span class="n">nwb</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
    <span class="n">cluster_id</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">local_cluster_id</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">peak_channel_index</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
    <span class="n">peak_channel_id</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
    <span class="n">local_peak_channel_id</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">rel_horz_pos</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
    <span class="n">rel_vert_pos</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span>
    <span class="n">isi_violations</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
    <span class="n">isolation_distance</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span>
    <span class="n">area</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">probe_id</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
    <span class="n">electrode_group</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="n">iUnit</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
    <span class="n">spike_times</span><span class="o">=</span><span class="n">spikes</span><span class="p">[</span><span class="n">iUnit</span><span class="p">],</span>
    <span class="n">waveform_mean</span><span class="o">=</span><span class="n">waveformMeans</span><span class="p">[</span><span class="n">iUnit</span><span class="p">]</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>Like when constructing the <code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table, we first define the columns of the <code class="docutils literal notranslate"><span class="pre">units</span></code> table by invoking the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> <code class="docutils literal notranslate"><span class="pre">add_unit_column</span></code> method (you can find its documentation <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=add_unit_column#pynwb.file.NWBFile.add_unit_column">here</a>). The column names are derived from the <code class="docutils literal notranslate"><span class="pre">columnLabels</span></code> variable which is defined inside the <code class="docutils literal notranslate"><span class="pre">getSpikes</span></code> function discussed in <a class="reference internal" href="#tutorials-silicon-probe-convert2nwb-py-init-spiking-data"><span class="std std-ref">one of the previous subsections</span></a>. Column descriptions are derived from the <code class="docutils literal notranslate"><span class="pre">columnDescription</span></code> variable which is also defined inside the same function. Once columns are defined, we add metadata, spike times, and waveforms for each unit individually using the <code class="docutils literal notranslate"><span class="pre">add_unit</span></code> method (documented <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=add_unit_column#pynwb.file.NWBFile.add_unit">here</a>).</p>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-pupil-area">
<span id="id6"></span><h4>Add Behavioural Module: Pupil Area Size<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-pupil-area" title="Permalink to this headline">#</a></h4>
<p>The code inside the <code class="docutils literal notranslate"><span class="pre">convert2nwb.py</span></code> file up to this point described how to convert spiking data into the NWB format. If there was no behavioural or other data recorded, the NWB file can now be saved. That is rarely the case, however, and this and the next subsections describe how to convert certain type of behavioural data into this format. We start with the data extracted after analysing recordings of the pupil area size.</p>
<p>We load pupil area size data from the same file containing processed spiking data. We then convert this data into a <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.base.html#pynwb.base.TimeSeries"><code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code></a> object which is designed to store any general purpose time series data. This object has a few mandatory properties, like <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">data</span></code>, and <code class="docutils literal notranslate"><span class="pre">unit</span></code> and a few optional ones, like <code class="docutils literal notranslate"><span class="pre">timestamps</span></code>, <code class="docutils literal notranslate"><span class="pre">control</span></code>, <code class="docutils literal notranslate"><span class="pre">control_description</span></code>, and <code class="docutils literal notranslate"><span class="pre">description</span></code>. The <code class="docutils literal notranslate"><span class="pre">data</span></code> property can be stored as any 1-D, 2-D, 3-D, or 4-D array where the first dimension is time. We use it to store our <code class="docutils literal notranslate"><span class="pre">pupilAreaSize</span></code> numpy vector. The <code class="docutils literal notranslate"><span class="pre">data_unit</span></code> property has to be a string, while the <code class="docutils literal notranslate"><span class="pre">timestamps</span></code> property should give data sampling times and should be stored as a unidimensional numpy array. The <code class="docutils literal notranslate"><span class="pre">control</span></code> property is used for labeling data samples with integers. The length of this array should be the same as the length of the first data dimension representing time. In our case I am using integers 0 and 1 to mark acceptable quality data. The meaning of these labels is provided by the <code class="docutils literal notranslate"><span class="pre">control_description</span></code> property which is a string describing labels in the increasing order. The full code that converts the pupil area size data into the appropriate form is shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pupilAreaSize</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">,</span>
  <span class="n">data</span><span class="o">=</span><span class="n">pupilAreaSize</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
  <span class="n">timestamps</span><span class="o">=</span><span class="n">videoFrameTimes</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
  <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;pixels^2&#39;</span><span class="p">,</span>
  <span class="n">control</span><span class="o">=</span><span class="n">acceptableSamples</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
  <span class="n">control_description</span><span class="o">=</span><span class="s1">&#39;low quality samples that should be excluded from analyses; acceptable quality samples&#39;</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Pupil area size over the recording session measured in pixels^2. &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;Acceptable quality period starting and ending times are given by data_continuity parameter. &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;The full data range can be divided into multiple acceptable periods.&#39;</span>
<span class="p">)</span>
<span class="n">behaviour_module</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">create_processing_module</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;contains behavioral data&quot;</span><span class="p">)</span>
<span class="n">pupilTracking</span> <span class="o">=</span> <span class="n">PupilTracking</span><span class="p">(</span><span class="n">pupilAreaSize</span><span class="p">)</span>
<span class="n">behaviour_module</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pupilTracking</span><span class="p">)</span>
</pre></div>
</div>
<p>As you will notice, our <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object <code class="docutils literal notranslate"><span class="pre">pupilAreaSize</span></code> is assigned to a <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.behavior.html#pynwb.behavior.PupilTracking"><code class="docutils literal notranslate"><span class="pre">PupilTracking</span></code></a> object which can hold one or more of the <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> objects. We also create a <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.base.html#pynwb.base.ProcessingModule"><code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code></a> container object to store the bahavioural data using the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> <code class="docutils literal notranslate"><span class="pre">create_processing_module</span></code> method (documented <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.file.html?highlight=ProcessingModule#pynwb.file.NWBFile.create_processing_module">here</a>). The final line adds the <code class="docutils literal notranslate"><span class="pre">PupilTracking</span></code> object to the <code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code> object by invoking the <code class="docutils literal notranslate"><span class="pre">add</span></code> method (documented <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.base.html#pynwb.base.ProcessingModule.add">here</a>).</p>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-movement">
<span id="id7"></span><h4>Add Behavioural Module: Total Facial Movement<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-movement" title="Permalink to this headline">#</a></h4>
<p>The facial movement data conversion process into appropriate form for NWB storage is almost identical to the conversion process applied to the pupil area size data. First, we load the data and store it inside the <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object. The steps are identical. Next, we store our <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> object inside the <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.behavior.html?highlight=BehavioralTimeSeries#pynwb.behavior.BehavioralTimeSeries"><code class="docutils literal notranslate"><span class="pre">BehavioralTimeSeries</span></code></a> object designed for holding one or more <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">behavioralTimeSeries</span> <span class="o">=</span> <span class="n">BehavioralTimeSeries</span><span class="p">(</span><span class="n">totalFaceMovement</span><span class="p">)</span>
</pre></div>
</div>
<p>We then then add the <code class="docutils literal notranslate"><span class="pre">BehavioralTimeSeries</span></code> object to the <code class="docutils literal notranslate"><span class="pre">ProcessingModule</span></code> container object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">behaviour_module</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">behavioralTimeSeries</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-save">
<span id="id8"></span><h4>Save NWB File<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-save" title="Permalink to this headline">#</a></h4>
<p>We use the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/pynwb.html?highlight=NWBHDF5IO#pynwb.NWBHDF5IO"><code class="docutils literal notranslate"><span class="pre">NWBHDF5IO</span></code> object</a> to save our data in the NWB format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">iSess</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
  <span class="n">nwbFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animalDerivedDataFolderNWB</span><span class="p">,</span> <span class="s1">&#39;ecephys_session_0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iSess</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nwb&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">nwbFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animalDerivedDataFolderNWB</span><span class="p">,</span> <span class="s1">&#39;ecephys_session_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iSess</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nwb&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">NWBHDF5IO</span><span class="p">(</span><span class="n">nwbFilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
  <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwb</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-read">
<span id="id9"></span><h4>Read NWB File<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-read" title="Permalink to this headline">#</a></h4>
<p>Reading NWB files in Python is done via the <code class="docutils literal notranslate"><span class="pre">NWBHDF5IO</span></code> class. Hence, import it by calling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynwb</span> <span class="kn">import</span> <span class="n">NWBHDF5IO</span>
</pre></div>
</div>
<p>Now if you want to open the NWB file that you just saved in Python, you can issue a command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;./npx_derived_data_nwb/M200324_MD/ecephys_session_01.nwb&#39;</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">NWBHDF5IO</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">nwb2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>which will read the file passively. The action is fast and it does not load all of the data at once but rather make it readily accessible. This is useful as it allows you to read data selectively without loading the entire file content into the computer memory.</p>
<p>If you want to read the entire unit table which has all unit spiking data and associated metadata, the easiest way is to issue a command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>which will specifically load and convert the HDF5 <code class="docutils literal notranslate"><span class="pre">DynamicTable</span></code> object into a pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> object. The latter is a common Python data type.</p>
<p>In contrast, if you are interested in a single unit data, you can load it using the following line of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">unitRowColLabels</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="n">unitRowValues</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>To load only spiking data for the same unit, the following line of code will do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">unitRowSpikeTimes</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s2">&quot;spike_times&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>If you want to load mean unit waveforms, the following line of code will load them as a numpy array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">unitWaveforms</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s2">&quot;waveform_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>Meanwhile, behavioural data can be accessed by running the code below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pupilAreaSize</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s1">&#39;behavior&#39;</span><span class="p">][</span><span class="s1">&#39;PupilTracking&#39;</span><span class="p">][</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
<span class="n">totalFacialMovement</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s1">&#39;behavior&#39;</span><span class="p">][</span><span class="s1">&#39;BehavioralTimeSeries&#39;</span><span class="p">][</span><span class="s1">&#39;TimeSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
</pre></div>
</div>
<p>Other associated behavioural properties can be accessed by replacing the <code class="docutils literal notranslate"><span class="pre">data</span></code> property by <code class="docutils literal notranslate"><span class="pre">timestamps</span></code> or <code class="docutils literal notranslate"><span class="pre">control</span></code> and so on.</p>
<p>Some metadata is often directly available as properties of the <code class="docutils literal notranslate"><span class="pre">NWBFile</span></code> object, like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sessionDescription</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">session_description</span>
</pre></div>
</div>
<p>Subject metadata is available via the command, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">animalID</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">subject_id</span>
</pre></div>
</div>
<p>While the electrode metadata can be accessed in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">electrodesTable</span> <span class="o">=</span> <span class="n">nwb2</span><span class="o">.</span><span class="n">ec_electrodes</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">electrodes</span></code> table is a pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> object and, therefore, methods of accessing it are the same as those discussed for accessing the <code class="docutils literal notranslate"><span class="pre">units</span></code> table.</p>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-validate">
<span id="id10"></span><h4>Validate NWB File<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-validate" title="Permalink to this headline">#</a></h4>
<p>For validating NWB files use command line and type in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">validate</span> <span class="o">./</span><span class="n">npx_derived_data_nwb</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="n">ecephys_session_01</span><span class="o">.</span><span class="n">nwb</span>
</pre></div>
</div>
<p>in order to validate the file that was recently created. The output should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Validating</span> <span class="o">./</span><span class="n">nnx_derived_data_nwb</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="n">ecephys_session_01</span><span class="o">.</span><span class="n">nwb</span> <span class="n">against</span> <span class="n">cached</span> <span class="n">namespace</span> <span class="n">information</span> <span class="n">using</span> <span class="n">namespace</span> <span class="s1">&#39;core&#39;</span><span class="o">.</span>
 <span class="o">-</span> <span class="n">no</span> <span class="n">errors</span> <span class="n">found</span><span class="o">.</span>
</pre></div>
</div>
<p>The program exit code should be 0. On error, the program exit code is 1 and the list of errors is outputted.</p>
<p>For more details on the validation process, refer to an external <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/validation.html">resource</a>.</p>
</section>
<section id="tutorials-silicon-probe-convert2nwb-py-resources">
<span id="id11"></span><h4>Resources<a class="headerlink" href="#tutorials-silicon-probe-convert2nwb-py-resources" title="Permalink to this headline">#</a></h4>
<p>This section explained how you can use Python to convert your processed spiking and behavioural data into NWB files. It is not an exhaustive overview of PyNWB package extracellular electrophysiology functionality. There are other potential use cases involving local field potentials (LFPs) and different types of behavioural data. There is a number of externally available tutorials covering some aspects of converting data obtained in extracellular electrophysiology experiments to the NWB file format using Python:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pynwb.readthedocs.io/en/stable/tutorials/general/file.html#sphx-glr-tutorials-general-file-py">NWB File Basics Tutorial</a></p></li>
<li><p><a class="reference external" href="https://pynwb.readthedocs.io/en/stable/tutorials/domain/ecephys.html#sphx-glr-tutorials-domain-ecephys-py">Extracellular Electrophysiology Data Tutorial</a></p></li>
<li><p><a class="reference external" href="https://pynwb.readthedocs.io/en/stable/tutorials/general/read_basics.html#sphx-glr-tutorials-general-read-basics-py">Reading and Exploring an NWB File Tutorial</a></p></li>
<li><p><a class="reference external" href="https://pynwb.readthedocs.io/en/stable/validation.html">Validating NWB files</a></p></li>
<li><p><a class="reference external" href="https://pynwb.readthedocs.io/en/stable/api_docs.html">PyNWB API Documentation</a></p></li>
<li><p><a class="reference external" href="https://nwb-schema.readthedocs.io/en/latest/index.html">NWB Schema Overview</a></p></li>
</ul>
</section>
</section>
<section id="examine-nwb-file-structure-using-hdfview">
<span id="tutorials-silicon-probe-convert2nwb-hdfview"></span><h3>Examine NWB File Structure Using HDFView<a class="headerlink" href="#examine-nwb-file-structure-using-hdfview" title="Permalink to this headline">#</a></h3>
<p>You can use <a class="reference external" href="https://www.hdfgroup.org/downloads/hdfview">HDF View</a> software to visualise the structure of your NWB files using a simple graphical interface.</p>
</section>
</section>
<section id="upload-your-standardised-data-to-remote-repository">
<span id="tutorials-silicon-probe-upload-nwb"></span><h2>Upload Your Standardised Data to Remote Repository<a class="headerlink" href="#upload-your-standardised-data-to-remote-repository" title="Permalink to this headline">#</a></h2>
<p>Let’s say that you have completed the conversion of your data to the NWB format and now want to upload them to the remote repository. First of all, copy the NWB files to appropriate folders within your local repository. For the Neuronexus and Neuropixels example data in this tutorial, the NWB files should be copied to these locations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infraslow</span><span class="o">-</span><span class="n">dynamics</span>\<span class="mi">03</span><span class="n">_data</span>\<span class="mi">101</span><span class="n">_uol_neuronexus_exp_derived_data</span>\<span class="n">M190114_A_MD</span>
<span class="n">infraslow</span><span class="o">-</span><span class="n">dynamics</span>\<span class="mi">03</span><span class="n">_data</span>\<span class="mi">102</span><span class="n">_uol_neuropixels_exp_derived_data</span>\<span class="n">M200324_MD</span>
</pre></div>
</div>
<p>Subsequently, navigate to the repository root folder and issue the following command in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">commit</span> <span class="o">.</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;Converted derived data to NWB&quot;</span>
</pre></div>
</div>
<p>This will commit changes to the local repository. To upload them to the remote repository, just type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">upload</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="roll-back-repository-to-an-earlier-version">
<span id="tutorials-silicon-probe-roll-back"></span><h2>Roll back Repository to an Earlier Version<a class="headerlink" href="#roll-back-repository-to-an-earlier-version" title="Permalink to this headline">#</a></h2>
<p>Now let’s assume you are not happy with the converted NWB files and you want to roll back to an earlier version of your repository prior to the conversion. Before we can do that, we need to find out the latest commit IDs by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">version</span>
</pre></div>
</div>
<p>You should see a terminal output that looks similar to this one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mi">1</span><span class="p">]</span>  <span class="mi">798</span><span class="n">d1e6</span> <span class="o">*</span> <span class="n">Fri</span> <span class="n">Nov</span> <span class="mi">11</span> <span class="mi">10</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">41</span> <span class="mi">2022</span> <span class="p">(</span><span class="o">+</span><span class="mi">0000</span><span class="p">)</span>

    <span class="n">Converted</span> <span class="n">derived</span> <span class="n">data</span> <span class="n">to</span> <span class="n">NWB</span>

  <span class="n">Added</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">101</span><span class="n">_uol_neuronexus_exp_derived_data</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="n">ecephys_session_01</span><span class="o">.</span><span class="n">nwb</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">102</span><span class="n">_uol_neuropixels_exp_derived_data</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="n">ecephys_session_01</span><span class="o">.</span><span class="n">nwb</span>

<span class="p">[</span> <span class="mi">2</span><span class="p">]</span>  <span class="n">f288303</span> <span class="o">*</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="mi">19</span> <span class="mi">13</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">27</span> <span class="mi">2022</span> <span class="p">(</span><span class="o">+</span><span class="mi">0100</span><span class="p">)</span>

    <span class="n">Added</span> <span class="n">a</span> <span class="n">few</span> <span class="n">larger</span> <span class="n">files</span>

  <span class="n">Modified</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="mi">201901221911031</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">ap_CAR</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="mi">201901221911031</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">lf</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="mi">2019012219110326</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">ap_CAR</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="mi">2019012219110326</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">lf</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">001</span><span class="n">_uol_neuronexus_exp_raw_derived</span><span class="o">/</span><span class="n">M190114_A_MD</span><span class="o">/</span><span class="n">video_79938</span><span class="o">.</span><span class="n">mp4</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="mi">202003241613491</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">ap_CAR</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="mi">202003241613491</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">lf</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="mi">202003241613492</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">ap_CAR</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="mi">202003241613492</span><span class="o">/</span><span class="n">continuous</span><span class="o">.</span><span class="n">lf</span><span class="o">.</span><span class="n">cbin</span><span class="p">,</span>
    <span class="mi">03</span><span class="n">_data</span><span class="o">/</span><span class="mi">002</span><span class="n">_uol_neuropixels_exp_raw_derived</span><span class="o">/</span><span class="n">M200324_MD</span><span class="o">/</span><span class="n">video_67929_low_quality</span><span class="o">.</span><span class="n">mp4</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Obviously we are interested in restoring the repository to the version just prior to the conversion and its ID is f288303. Now we type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gin</span> <span class="n">version</span> <span class="o">--</span><span class="nb">id</span> <span class="n">f288303</span>
</pre></div>
</div>
<p>The local repository now should be rolled back to its previous version.</p>
<p>Rolling back versions may produce some unintuitive results. Rolling back versions replaces new files with their earlier versions. However, if those files were not present in previous versions, they are kept in the rolled back version. Therefore, the new files have to be deleted manually after the roll back. This may seem like a bug but it actually is an intentional behaviour.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Bristol%20GIN%20via%20Command%20Line.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Bristol GIN via Command Line</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Bristol%20GIN%20for%20Patch%20Clamp%20Data.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Bristol GIN for Patch Clamp Data</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Martynas Dervinis<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>